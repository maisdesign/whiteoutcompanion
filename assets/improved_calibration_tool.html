<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Whiteout Survival - Calibrazione Coordinati</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .control-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .checkbox-container {
            background: rgba(67, 233, 123, 0.1);
            border: 2px solid rgba(67, 233, 123, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #43e97b;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-success { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; }
        .btn-warning { background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%); color: white; }
        .btn-danger { background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; }
        .btn-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
            align-items: start;
        }

        .map-section {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .map-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 20px auto;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
        }

        #map {
            width: 100%;
            height: auto;
            display: block;
            cursor: crosshair;
        }

        .marker {
            position: absolute;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            z-index: 10;
        }

        .marker:hover {
            transform: scale(1.5);
            z-index: 20;
        }

        .marker.castle { background: #ffd700; border: 3px solid #ff6b35; }
        .marker.construction { background: #3498db; }
        .marker.production { background: #e74c3c; }
        .marker.defense { background: #9b59b6; }
        .marker.gathering { background: #2ecc71; }
        .marker.tech { background: #f39c12; }
        .marker.weapons { background: #34495e; }
        .marker.training { background: #e67e22; }
        .marker.expedition { background: #1abc9c; }
        .marker.stronghold { background: #8e44ad; }
        .marker.fortress { background: #c0392b; }

        .marker-label {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            transition: opacity 0.2s ease;
            pointer-events: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .marker:hover .marker-label {
            opacity: 1;
        }

        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: fit-content;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .facility-list {
            max-height: 300px;
            overflow-y: auto;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
        }

        .facility-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .facility-item:last-child {
            border-bottom: none;
        }

        .facility-type {
            font-weight: bold;
            color: #4facfe;
        }

        .coordinates {
            font-family: monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
            background: rgba(79, 172, 254, 0.2);
            border: 1px solid rgba(79, 172, 254, 0.5);
        }

        .calibration-controls {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .offset-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }

        .offset-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .offset-input label {
            font-size: 12px;
            font-weight: bold;
        }

        .offset-input input {
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            font-size: 14px;
        }

        .code-output {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            margin-top: 15px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .controls {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üó∫Ô∏è Whiteout Survival - Calibrazione Coordinati</h1>
            <p>Strumento per calibrare le coordinate delle strutture sulla mappa</p>
        </div>

        <div class="controls">
            <div class="control-group">
                <h3>üìã Carica Dati Strutture</h3>
                <div class="checkbox-container">
                    <label class="checkbox-label">
                        <input type="checkbox" id="loadDataCheckbox">
                        <span>Carica le 91 strutture predefinite</span>
                    </label>
                    <div style="font-size: 12px; opacity: 0.8; margin-top: 8px;">
                        ‚ú® Spunta per caricare automaticamente tutti i punti delle strutture
                    </div>
                </div>
                <button class="btn btn-info" id="testAlignmentBtn">üéØ Test Allineamento (4 punti)</button>
                <button class="btn btn-danger" id="clearAllBtn">üóëÔ∏è Cancella Tutto</button>
            </div>

            <div class="control-group">
                <h3>‚öôÔ∏è Controlli Calibrazione</h3>
                <div class="offset-controls">
                    <div class="offset-input">
                        <label>Offset X:</label>
                        <input type="number" id="offsetX" value="0" step="0.1">
                    </div>
                    <div class="offset-input">
                        <label>Offset Y:</label>
                        <input type="number" id="offsetY" value="0" step="0.1">
                    </div>
                    <div class="offset-input">
                        <label>Scala X:</label>
                        <input type="number" id="scaleX" value="1" step="0.01" min="0.5" max="2">
                    </div>
                    <div class="offset-input">
                        <label>Scala Y:</label>
                        <input type="number" id="scaleY" value="1" step="0.01" min="0.5" max="2">
                    </div>
                </div>
                <button class="btn btn-warning" id="resetCalibrationBtn">üîÑ Reset Calibrazione</button>
            </div>
        </div>

        <div class="main-content">
            <div class="map-section">
                <h3>üéØ Mappa Interattiva</h3>
                <div class="status" id="statusMessage">
                    Spunta la checkbox per caricare le strutture predefinite
                </div>
                
                <div class="map-container">
                    <img src="map.png" id="map" alt="Whiteout Survival Map">
                </div>
            </div>

            <div class="sidebar">
                <div>
                    <h3>üìä Progresso</h3>
                    <div>
                        <span id="facilitiesCount">0</span> strutture caricate
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="facility-list">
                    <h4>üìã Strutture per Tipo</h4>
                    <div id="facilityListContent">
                        <p style="opacity: 0.6; font-style: italic;">Nessuna struttura caricata</p>
                    </div>
                </div>

                <div>
                    <h4>üíæ Esportazione</h4>
                    <button class="btn btn-success" id="generateCodeBtn" style="width: 100%; margin-bottom: 10px;">
                        üìÑ Genera facilitiesData.js
                    </button>
                    <button class="btn btn-primary" id="copyCodeBtn" style="width: 100%; margin-bottom: 10px;">
                        üìã Copia negli Appunti
                    </button>
                    <button class="btn btn-warning" id="downloadBtn" style="width: 100%;">
                        üíæ Scarica File
                    </button>
                </div>
            </div>
        </div>

        <div id="outputSection" style="margin-top: 30px; display: none;">
            <h3>üìÑ Codice Generato</h3>
            <div class="code-output" id="codeOutput"></div>
        </div>
    </div>

    <script>
        // Dati delle strutture predefinite
        const predefinedData = [
          { "Type": "Castle", "Level": "Lv.1", "x": 50.06, "y": 48.79, "ingameCoords": "X:597 Y:597" },
          { "Type": "Construction", "Level": "Lv.1", "x": 50.19, "y": 12.48, "ingameCoords": "X:168 Y:168" },
          { "Type": "Construction", "Level": "Lv.1", "x": 66.19, "y": 70.48, "ingameCoords": "X:537 Y:138" },
          { "Type": "Construction", "Level": "Lv.1", "x": 87.19, "y": 49.32, "ingameCoords": "X:1068 X:138" },
          { "Type": "Construction", "Level": "Lv.1", "x": 29.31, "y": 65.37, "ingameCoords": "X:138 Y:666" },
          { "Type": "Construction", "Level": "Lv.1", "x": 14.19, "y": 50.73, "ingameCoords": "X:138 Y:1038" },
          { "Type": "Construction", "Level": "Lv.1", "x": 34.06, "y": 28.52, "ingameCoords": "X:666 Y:1068" },
          { "Type": "Construction", "Level": "Lv.1", "x": 70.19, "y": 32.57, "ingameCoords": "X:1068 Y:567" },
          { "Type": "Construction", "Level": "Lv.1", "x": 50.19, "y": 86.35, "ingameCoords": "X:138 Y:138" },
          { "Type": "Construction", "Level": "Lv.3", "x": 56.44, "y": 65.19, "ingameCoords": "X:486 Y:327" },
          { "Type": "Construction", "Level": "Lv.3", "x": 46.31, "y": 32.57, "ingameCoords": "X:768 Y:867" },
          { "Type": "Construction", "Level": "Lv.3", "x": 62.19, "y": 40.33, "ingameCoords": "X:867 Y:567" },
          { "Type": "Construction", "Level": "Lv.3", "x": 36.81, "y": 57.96, "ingameCoords": "X:327 Y:666" },
          { "Type": "Production", "Level": "Lv.1", "x": 83.31, "y": 45.45, "ingameCoords": "X:1068 Y:237" },
          { "Type": "Production", "Level": "Lv.1", "x": 75.19, "y": 61.49, "ingameCoords": "X:768 Y:138" },
          { "Type": "Production", "Level": "Lv.1", "x": 54.06, "y": 82.65, "ingameCoords": "X:237 Y:138" },
          { "Type": "Production", "Level": "Lv.1", "x": 42.56, "y": 78.94, "ingameCoords": "X:138 Y:327" },
          { "Type": "Production", "Level": "Lv.1", "x": 17.44, "y": 53.73, "ingameCoords": "X:138 Y:957" },
          { "Type": "Production", "Level": "Lv.1", "x": 21.81, "y": 42.98, "ingameCoords": "X:327 Y:1038" },
          { "Type": "Production", "Level": "Lv.1", "x": 63.19, "y": 25.17, "ingameCoords": "X:1068 Y:747" },
          { "Type": "Production", "Level": "Lv.1", "x": 45.69, "y": 17.06, "ingameCoords": "X:957 Y:1068" },
          { "Type": "Defense", "Level": "Lv.2", "x": 71.19, "y": 65.54, "ingameCoords": "X:666 Y:138" },
          { "Type": "Defense", "Level": "Lv.2", "x": 56.81, "y": 69.42, "ingameCoords": "X:438 Y:267" },
          { "Type": "Defense", "Level": "Lv.2", "x": 34.19, "y": 70.48, "ingameCoords": "X:138 Y:537" },
          { "Type": "Defense", "Level": "Lv.2", "x": 29.19, "y": 57.43, "ingameCoords": "X:237 Y:768" },
          { "Type": "Defense", "Level": "Lv.2", "x": 30.19, "y": 35.04, "ingameCoords": "X:537 Y:1038" },
          { "Type": "Defense", "Level": "Lv.2", "x": 41.44, "y": 30.11, "ingameCoords": "X:738 Y:957" },
          { "Type": "Defense", "Level": "Lv.2", "x": 66.19, "y": 28.34, "ingameCoords": "X:1068 Y:666" },
          { "Type": "Defense", "Level": "Lv.2", "x": 70.81, "y": 42.1, "ingameCoords": "X:957 Y:438" },
          { "Type": "Defense", "Level": "Lv.4", "x": 54.06, "y": 36.45, "ingameCoords": "X:816 Y:717" },
          { "Type": "Defense", "Level": "Lv.4", "x": 37.06, "y": 53.38, "ingameCoords": "X:387 Y:717" },
          { "Type": "Defense", "Level": "Lv.4", "x": 60.56, "y": 61.14, "ingameCoords": "X:588 Y:327" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 82.81, "y": 53.91, "ingameCoords": "X:957 Y:138" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 46.44, "y": 82.65, "ingameCoords": "X:138 Y:237" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 68.06, "y": 72.77, "ingameCoords": "X:537 Y:87" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 26.94, "y": 67.48, "ingameCoords": "X:87 Y:666" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 18.19, "y": 44.39, "ingameCoords": "X:267 Y:1068" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 30.06, "y": 26.93, "ingameCoords": "X:636 Y:1137" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 72.81, "y": 29.93, "ingameCoords": "X:1137 Y:567" },
          { "Type": "Gathering", "Level": "Lv.1", "x": 55.44, "y": 17.59, "ingameCoords": "X:1068 Y:936" },
          { "Type": "Tech", "Level": "Lv.1", "x": 78.94, "y": 50.03, "ingameCoords": "X:957 Y:237" },
          { "Type": "Tech", "Level": "Lv.1", "x": 66.06, "y": 60.25, "ingameCoords": "X:666 Y:267" },
          { "Type": "Tech", "Level": "Lv.1", "x": 50.31, "y": 78.77, "ingameCoords": "X:237 Y:237" },
          { "Type": "Tech", "Level": "Lv.1", "x": 39.44, "y": 65.37, "ingameCoords": "X:267 Y:537" },
          { "Type": "Tech", "Level": "Lv.1", "x": 21.44, "y": 49.85, "ingameCoords": "X:237 Y:957" },
          { "Type": "Tech", "Level": "Lv.1", "x": 34.31, "y": 38.75, "ingameCoords": "X:537 Y:936" },
          { "Type": "Tech", "Level": "Lv.1", "x": 66.06, "y": 39.1, "ingameCoords": "X:936 Y:537" },
          { "Type": "Tech", "Level": "Lv.1", "x": 50.19, "y": 21.29, "ingameCoords": "X:957 Y:957" },
          { "Type": "Tech", "Level": "Lv.3", "x": 71.75, "y": 50.03, "ingameCoords": "X:867 Y:327" },
          { "Type": "Tech", "Level": "Lv.3", "x": 50.25, "y": 71.36, "ingameCoords": "X:327 Y:327" },
          { "Type": "Tech", "Level": "Lv.3", "x": 28.63, "y": 49.85, "ingameCoords": "X:327 Y:867" },
          { "Type": "Tech", "Level": "Lv.3", "x": 50.13, "y": 28.52, "ingameCoords": "X:867 Y:867" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 79.13, "y": 57.43, "ingameCoords": "X:867 Y:138" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 59.13, "y": 77.18, "ingameCoords": "X:366 Y:138" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 38.25, "y": 74.54, "ingameCoords": "X:138 Y:438" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 21, "y": 57.61, "ingameCoords": "X:138 Y:867" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 25, "y": 37.69, "ingameCoords": "X:438 Y:1068" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 79.63, "y": 41.92, "ingameCoords": "X:1068 Y:327" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 58.13, "y": 20.76, "ingameCoords": "X:1068 Y:867" },
          { "Type": "Weapons", "Level": "Lv.2", "x": 42, "y": 20.41, "ingameCoords": "X:867 Y:1068" },
          { "Type": "Weapons", "Level": "Lv.4", "x": 63.5, "y": 45.27, "ingameCoords": "X:816 Y:486" },
          { "Type": "Weapons", "Level": "Lv.4", "x": 46.13, "y": 62.9, "ingameCoords": "X:387 Y:486" },
          { "Type": "Weapons", "Level": "Lv.4", "x": 38.88, "y": 39.8, "ingameCoords": "X:588 Y:867" },
          { "Type": "Training", "Level": "Lv.2", "x": 40.13, "y": 68.72, "ingameCoords": "X:237 Y:486" },
          { "Type": "Training", "Level": "Lv.2", "x": 25.62, "y": 62.19, "ingameCoords": "X:138 Y:747" },
          { "Type": "Training", "Level": "Lv.2", "x": 31.37, "y": 40.16, "ingameCoords": "X:486 Y:957" },
          { "Type": "Training", "Level": "Lv.2", "x": 39.25, "y": 25.52, "ingameCoords": "X:768 Y:1038" },
          { "Type": "Training", "Level": "Lv.2", "x": 58.25, "y": 29.93, "ingameCoords": "X:957 Y:747" },
          { "Type": "Training", "Level": "Lv.2", "x": 73.25, "y": 35.92, "ingameCoords": "X:1068 Y:486" },
          { "Type": "Training", "Level": "Lv.2", "x": 63.88, "y": 72.77, "ingameCoords": "X:486 Y:138" },
          { "Type": "Training", "Level": "Lv.2", "x": 71.13, "y": 57.43, "ingameCoords": "X:768 Y:237" },
          { "Type": "Expedition", "Level": "Lv.3", "x": 67.63, "y": 53.91, "ingameCoords": "X:768" },
          { "Type": "Expedition", "Level": "Lv.3", "x": 40.63, "y": 61.84, "ingameCoords": "X:327 Y:567" },
          { "Type": "Expedition", "Level": "Lv.3", "x": 34.88, "y": 43.68, "ingameCoords": "X:486 Y:867" },
          { "Type": "Expedition", "Level": "Lv.3", "x": 58.13, "y": 36.28, "ingameCoords": "X:867 Y:666" },
          { "Type": "Stronghold", "Level": "Lv.1", "x": 41.75, "y": 41.57 },
          { "Type": "Stronghold", "Level": "Lv.2", "x": 42.25, "y": 57.61 },
          { "Type": "Stronghold", "Level": "Lv.3", "x": 57.63, "y": 57.61 },
          { "Type": "Stronghold", "Level": "Lv.4", "x": 58, "y": 41.39 },
          { "Type": "Fortress", "Level": "Lv.1", "x": 26.63, "y": 54.97 },
          { "Type": "Fortress", "Level": "Lv.2", "x": 35.13, "y": 63.6 },
          { "Type": "Fortress", "Level": "Lv.3", "x": 45.63, "y": 74.01 },
          { "Type": "Fortress", "Level": "Lv.4", "x": 55.38, "y": 73.65 },
          { "Type": "Fortress", "Level": "Lv.5", "x": 64, "y": 64.31 },
          { "Type": "Fortress", "Level": "Lv.6", "x": 74.25, "y": 54.08 },
          { "Type": "Fortress", "Level": "Lv.7", "x": 74.25, "y": 45.45 },
          { "Type": "Fortress", "Level": "Lv.8", "x": 64.13, "y": 35.22 },
          { "Type": "Fortress", "Level": "Lv.9", "x": 55.25, "y": 26.23 },
          { "Type": "Fortress", "Level": "Lv.10", "x": 45.63, "y": 25.35 },
          { "Type": "Fortress", "Level": "Lv.11", "x": 35.88, "y": 34.87 },
          { "Type": "Fortress", "Level": "Lv.12", "x": 26.38, "y": 44.21 }
        ];

        // Variabili globali
        let facilities = [];
        let calibrationData = { offsetX: 0, offsetY: 0, scaleX: 1, scaleY: 1 };

        // Elementi DOM
        const loadDataCheckbox = document.getElementById('loadDataCheckbox');
        const testAlignmentBtn = document.getElementById('testAlignmentBtn');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const offsetXInput = document.getElementById('offsetX');
        const offsetYInput = document.getElementById('offsetY');
        const scaleXInput = document.getElementById('scaleX');
        const scaleYInput = document.getElementById('scaleY');
        const resetCalibrationBtn = document.getElementById('resetCalibrationBtn');
        const generateCodeBtn = document.getElementById('generateCodeBtn');
        const copyCodeBtn = document.getElementById('copyCodeBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusMessage = document.getElementById('statusMessage');
        const facilitiesCount = document.getElementById('facilitiesCount');
        const progressBar = document.getElementById('progressBar');
        const facilityListContent = document.getElementById('facilityListContent');
        const mapContainer = document.querySelector('.map-container');

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, setting up event listeners...');
            
            loadDataCheckbox.addEventListener('change', function() {
                console.log('Checkbox changed:', this.checked);
                if (this.checked) {
                    loadPredefinedData();
                } else {
                    clearAllData();
                }
            });

            testAlignmentBtn.addEventListener('click', function() {
                console.log('Test alignment clicked');
                addTestMarkers();
            });

            clearAllBtn.addEventListener('click', function() {
                console.log('Clear all clicked');
                clearAllData();
                loadDataCheckbox.checked = false;
            });

            // Calibration controls
            [offsetXInput, offsetYInput, scaleXInput, scaleYInput].forEach(input => {
                input.addEventListener('change', applyCalibration);
            });

            resetCalibrationBtn.addEventListener('click', resetCalibration);
            generateCodeBtn.addEventListener('click', generateCode);
            copyCodeBtn.addEventListener('click', copyToClipboard);
            downloadBtn.addEventListener('click', downloadFile);

            console.log('Event listeners set up successfully');
        });

        // Funzioni principali
        function loadPredefinedData() {
            console.log('Loading predefined data...');
            facilities = [...predefinedData];
            updateUI();
            statusMessage.textContent = `‚úÖ Caricate ${facilities.length} strutture! Verifica l'allineamento sulla mappa.`;
            statusMessage.style.background = 'rgba(67, 233, 123, 0.2)';
            statusMessage.style.borderColor = 'rgba(67, 233, 123, 0.5)';
            
            // Crea tutti i marker
            createAllMarkers();
        }

        function addTestMarkers() {
            console.log('Adding test markers...');
            const testData = [
                { "Type": "Castle", "Level": "Lv.1", "x": 50.06, "y": 48.79 },
                { "Type": "Construction", "Level": "Lv.1", "x": 50.19, "y": 12.48 },
                { "Type": "Defense", "Level": "Lv.2", "x": 71.19, "y": 65.54 },
                { "Type": "Fortress", "Level": "Lv.1", "x": 26.63, "y": 54.97 }
            ];
            
            facilities = [...testData];
            updateUI();
            createAllMarkers();
            statusMessage.textContent = 'üéØ 4 marker di test aggiunti. Verifica se sono allineati con le strutture sulla mappa.';
            statusMessage.style.background = 'rgba(79, 172, 254, 0.2)';
        }

        function clearAllData() {
            console.log('Clearing all data...');
            facilities = [];
            document.querySelectorAll('.marker').forEach(marker => marker.remove());
            updateUI();
            statusMessage.textContent = 'Tutti i dati sono stati cancellati.';
            statusMessage.style.background = 'rgba(255, 193, 7, 0.2)';
        }

        function createAllMarkers() {
            console.log('Creating markers for', facilities.length, 'facilities');
            // Rimuovi marker esistenti
            document.querySelectorAll('.marker').forEach(marker => marker.remove());
            
            // Crea nuovi marker
            facilities.forEach((facility, index) => {
                createMarker(facility, index);
            });
        }

        function createMarker(facility, index) {
            const marker = document.createElement('div');
            marker.className = `marker ${facility.Type.toLowerCase()}`;
            
            // Applica calibrazione
            let visualX = (facility.x + calibrationData.offsetX) * calibrationData.scaleX;
            let visualY = (facility.y + calibrationData.offsetY) * calibrationData.scaleY;
            
            marker.style.left = `calc(${visualX}% - 6px)`;
            marker.style.top = `calc(${visualY}% - 6px)`;
            
            // Aggiungi label
            const label = document.createElement('div');
            label.className = 'marker-label';
            label.textContent = `${facility.Type} ${facility.Level}${facility.ingameCoords ? ' (' + facility.ingameCoords + ')' : ''}`;
            marker.appendChild(label);
            
            mapContainer.appendChild(marker);
        }

        function applyCalibration() {
            console.log('Applying calibration...');
            calibrationData.offsetX = parseFloat(offsetXInput.value) || 0;
            calibrationData.offsetY = parseFloat(offsetYInput.value) || 0;
            calibrationData.scaleX = parseFloat(scaleXInput.value) || 1;
            calibrationData.scaleY = parseFloat(scaleYInput.value) || 1;
            
            createAllMarkers();
        }

        function resetCalibration() {
            console.log('Resetting calibration...');
            calibrationData = { offsetX: 0, offsetY: 0, scaleX: 1, scaleY: 1 };
            offsetXInput.value = 0;
            offsetYInput.value = 0;
            scaleXInput.value = 1;
            scaleYInput.value = 1;
            createAllMarkers();
        }

        function updateUI() {
            // Aggiorna contatore
            facilitiesCount.textContent = facilities.length;
            
            // Aggiorna barra progresso
            const percentage = Math.min((facilities.length / 91) * 100, 100);
            progressBar.style.width = percentage + '%';
            
            // Aggiorna lista strutture
            updateFacilityList();
        }

        function updateFacilityList() {
            if (facilities.length === 0) {
                facilityListContent.innerHTML = '<p style="opacity: 0.6; font-style: italic;">Nessuna struttura caricata</p>';
                return;
            }
            
            // Raggruppa per tipo
            const grouped = {};
            facilities.forEach(facility => {
                const key = `${facility.Type} ${facility.Level}`;
                if (!grouped[key]) grouped[key] = 0;
                grouped[key]++;
            });
            
            let html = '';
            Object.entries(grouped).forEach(([key, count]) => {
                html += `
                    <div class="facility-item">
                        <span class="facility-type">${key}</span>
                        <span class="coordinates">${count}x</span>
                    </div>
                `;
            });
            
            facilityListContent.innerHTML = html;
        }

        function generateCode() {
            if (facilities.length === 0) {
                alert('Carica prima alcune strutture!');
                return;
            }
            
            let code = `// ===== WHITEOUT SURVIVAL FACILITY DATA - CALIBRATED COORDINATES =====
// Generated on ${new Date().toLocaleDateString()} with ${facilities.length} facilities

const facilityData = [
`;
            
            facilities.forEach((facility, index) => {
                // Applica calibrazione ai dati di output
                const calibratedX = Math.round(((facility.x + calibrationData.offsetX) * calibrationData.scaleX) * 100) / 100;
                const calibratedY = Math.round(((facility.y + calibrationData.offsetY) * calibrationData.scaleY) * 100) / 100;
                
                code += `  { 
    "Type": "${facility.Type}", 
    "Level": "${facility.Level}", 
    "x": ${calibratedX}, 
    "y": ${calibratedY}${facility.ingameCoords ? `,
    "ingameCoords": "${facility.ingameCoords}"` : ''} 
  }`;
                if (index < facilities.length - 1) code += ',';
                code += '\n';
            });
            
            code += `];

// Export for use in your app
if (typeof window !== 'undefined') {
  window.facilityData = facilityData;
}

// CommonJS support
if (typeof module !== 'undefined' && module.exports) {
  module.exports = facilityData;
}`;
            
            document.getElementById('codeOutput').textContent = code;
            document.getElementById('outputSection').style.display = 'block';
            document.getElementById('outputSection').scrollIntoView({ behavior: 'smooth' });
        }

        function copyToClipboard() {
            generateCode();
            const code = document.getElementById('codeOutput').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('‚úÖ Codice copiato negli appunti!');
            }).catch(() => {
                alert('‚ùå Errore nella copia. Seleziona e copia manualmente.');
            });
        }

        function downloadFile() {
            generateCode();
            const code = document.getElementById('codeOutput').textContent;
            const blob = new Blob([code], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'facilitiesData_calibrated.js';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Gestione errori immagine
        document.getElementById('map').addEventListener('error', function() {
            console.error('Errore caricamento mappa');
            statusMessage.textContent = '‚ùå Errore: Impossibile caricare map.png. Assicurati che il file sia presente.';
            statusMessage.style.background = 'rgba(220, 53, 69, 0.2)';
        });

        // Log per debug
        console.log('Script loaded successfully');
    </script>
</body>
</html>
