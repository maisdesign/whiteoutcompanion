<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#1e3c72">
  <meta name="description" content="Professional alliance management tool for Whiteout Survival">
  
  <title>Whiteout Survival Companion</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* Base Styles */
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.8);
      --spacing-md: 16px;
      --radius-md: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
    }

    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    .app-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 30px;
      align-items: start;
    }

    .sidebar {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: 20px;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* Calibration Controls */
    .calibration-section {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      padding: 20px;
      border-radius: var(--radius-md);
      margin-bottom: 20px;
    }

    .calibration-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calibration-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
      padding: 5px;
    }

    .calibration-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-group label {
      font-size: 12px;
      font-weight: bold;
      color: var(--text-secondary);
    }

    .control-group input {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 14px;
    }

    .calibration-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    /* Alliance Form */
    .alliance-form {
      margin-bottom: 20px;
    }

    .alliance-form input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--glass-border);
      border-radius: 8px;
      background: var(--glass-bg);
      color: var(--text-primary);
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
    }

    .alliance-form input::placeholder {
      color: var(--text-secondary);
    }

    .alliance-form input[type="file"] {
      padding: 8px;
      border-style: dashed;
    }

    /* Alliance List */
    .alliance-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alliance-item {
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
    }

    .alliance-item:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.12);
    }

    .alliance-item img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }

    .alliance-name {
      flex: 1;
      font-weight: 500;
    }

    .alliance-actions {
      display: flex;
      gap: 5px;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    .edit-btn:hover {
      background: rgba(255, 193, 7, 0.2);
    }

    .delete-btn:hover {
      background: rgba(220, 53, 69, 0.2);
    }

    /* Map Container */
    .map-container {
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .map-status {
      background: rgba(79, 172, 254, 0.2);
      border: 1px solid rgba(79, 172, 254, 0.5);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .map-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: auto;
      display: block;
      cursor: crosshair;
    }

    .marker {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      z-index: 10;
      background-color: #4facfe;
    }

    .marker:hover {
      transform: scale(1.5);
      z-index: 20;
    }

    .marker.castle { 
      background: #ffd700; 
      border: 3px solid #ff6b35;
      width: 16px;
      height: 16px;
    }

    .marker.assigned {
      background-color: #43e97b;
    }

    .marker img {
      position: absolute;
      left: 50%;
      top: 0;
      width: 20px;
      height: 20px;
      transform: translate(-50%, -100%);
      z-index: 11;
      pointer-events: none;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.9);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      background: white;
    }

    .marker-dropdown {
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 2px solid #4facfe;
      border-radius: 8px;
      padding: 4px;
      font-size: 12px;
      min-width: 120px;
      color: var(--text-primary);
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-md);
      padding: 15px;
      text-align: center;
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: #4facfe;
      margin-bottom: 4px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Summary Sections */
    .summary-section {
      margin-bottom: 20px;
      padding: 20px;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
      padding: 5px;
      border-radius: 8px;
      transition: background-color 0.2s;
    }

    .summary-header:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .section-toggle {
      font-size: 14px;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }

    .section-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .summary-content {
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .app-layout {
        grid-template-columns: 1fr;
      }
      
      .calibration-controls {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .header h1 {
        font-size: 2rem;
      }
      
      .calibration-controls {
        grid-template-columns: 1fr;
      }
      
      .calibration-buttons {
        flex-direction: column;
      }
      
      .controls {
        flex-direction: column;
      }
      
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Loading Animation */
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.1);
      border-left: 4px solid #4facfe;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Hide/Show sections */
    .hidden {
      display: none;
    }

    .collapsed-content {
      max-height: 0;
      overflow: hidden;
    }

    .expanded-content {
      max-height: 2000px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1>üó∫Ô∏è Whiteout Survival Companion</h1>
      <p>Professional alliance management with map calibration</p>
    </div>

    <!-- App Layout -->
    <div class="app-layout">
      
      <!-- Sidebar -->
      <aside class="sidebar glass-card">
        <!-- Quick Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="total-alliances">0</div>
            <div class="stat-label">Alleanze</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="assigned-facilities">0</div>
            <div class="stat-label">Assegnate</div>
          </div>
        </div>

        <!-- Alliance Form -->
        <h3>üè∞ Gestione Alleanze</h3>
        <form class="alliance-form" id="alliance-form">
          <input type="text" id="alliance-name" placeholder="Nome alleanza..." maxlength="30" required>
          <input type="file" id="alliance-icon" accept="image/*">
          <button type="submit" class="btn btn-primary" style="width: 100%;">
            ‚ú® Aggiungi Alleanza
          </button>
        </form>

        <!-- Alliance List -->
        <ul class="alliance-list" id="alliance-list"></ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        
        <!-- Calibration Section -->
        <section class="calibration-section glass-card">
          <div class="calibration-header">
            <h3>üéØ Calibrazione Mappa</h3>
            <button class="calibration-toggle" onclick="toggleCalibration()">‚ñº</button>
          </div>
          
          <div id="calibration-content" class="expanded-content">
            <div class="calibration-controls">
              <div class="control-group">
                <label>Offset X:</label>
                <input type="number" id="offsetX" value="0" step="0.1">
              </div>
              <div class="control-group">
                <label>Offset Y:</label>
                <input type="number" id="offsetY" value="0.7" step="0.1">
              </div>
              <div class="control-group">
                <label>Scala X:</label>
                <input type="number" id="scaleX" value="1" step="0.01" min="0.5" max="2">
              </div>
              <div class="control-group">
                <label>Scala Y:</label>
                <input type="number" id="scaleY" value="1" step="0.01" min="0.5" max="2">
              </div>
            </div>
            
            <div class="calibration-buttons">
              <button class="btn btn-info" onclick="highlightCastle()">üè∞ Evidenzia Castello</button>
              <button class="btn btn-warning" onclick="testCurrentCalibration()">üéØ Test Calibrazione</button>
              <button class="btn btn-success" onclick="applyCalibration()">‚úÖ Applica</button>
              <button class="btn btn-primary" onclick="resetCalibration()">üîÑ Reset</button>
            </div>
          </div>
        </section>

        <!-- Controls -->
        <div class="controls">
          <button class="btn btn-success" onclick="exportCSV()">üìä Esporta CSV</button>
          <button class="btn btn-info" onclick="exportPNG()">üñºÔ∏è Esporta PNG</button>
          <input type="file" id="import-file" accept=".csv" style="display: none;">
          <button class="btn btn-primary" onclick="document.getElementById('import-file').click()">üì• Importa CSV</button>
        </div>

        <!-- Map Container -->
        <section class="map-container glass-card">
          <div class="map-header">
            <h3>üó∫Ô∏è Mappa Interattiva</h3>
          </div>
          
          <div class="map-status" id="map-status">
            Carica alcune alleanze e inizia ad assegnare le strutture cliccando sui marker
          </div>
          
          <div class="map-wrapper" id="map-wrapper">
            <img src="https://i.imgur.com/placeholder.png" id="map" alt="Whiteout Survival Map" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxOCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1hcHBhIGRlbCBHaW9jbyAoU29zdGl0dWlyZSBjb24gbGEgbWFwcGEgdmVyYSk8L3RleHQ+PC9zdmc+';">
          </div>
        </section>

        <!-- Summary Sections -->
        <section class="summary-section glass-card">
          <div class="summary-header" onclick="toggleSection('facility-summary')">
            <h3>üìã Riepilogo Strutture</h3>
            <span class="section-toggle" id="facility-toggle">‚ñº</span>
          </div>
          <div id="facility-summary-content" class="summary-content expanded-content">
            <div id="facility-summary"></div>
          </div>
        </section>

        <section class="summary-section glass-card">
          <div class="summary-header" onclick="toggleSection('buff-summary')">
            <h3>‚ö° Riepilogo Buff</h3>
            <span class="section-toggle" id="buff-toggle">‚ñº</span>
          </div>
          <div id="buff-summary-content" class="summary-content expanded-content">
            <div id="buff-summary"></div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script>
    // === DATA ===
    const facilityData = [
      { "Type": "Castle", "Level": "Lv.1", "x": 50.06, "y": 48.79, "ingameCoords": "X:597 Y:597" },
      { "Type": "Construction", "Level": "Lv.1", "x": 50.19, "y": 12.48, "ingameCoords": "X:168 Y:168" },
      { "Type": "Construction", "Level": "Lv.1", "x": 66.19, "y": 70.48, "ingameCoords": "X:537 Y:138" },
      { "Type": "Production", "Level": "Lv.1", "x": 83.31, "y": 45.45, "ingameCoords": "X:1068 Y:237" },
      { "Type": "Defense", "Level": "Lv.2", "x": 71.19, "y": 65.54, "ingameCoords": "X:666 Y:138" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 82.81, "y": 53.91, "ingameCoords": "X:957 Y:138" },
      { "Type": "Tech", "Level": "Lv.1", "x": 78.94, "y": 50.03, "ingameCoords": "X:957 Y:237" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 79.13, "y": 57.43, "ingameCoords": "X:867 Y:138" },
      { "Type": "Training", "Level": "Lv.2", "x": 40.13, "y": 68.72, "ingameCoords": "X:237 Y:486" },
      { "Type": "Fortress", "Level": "Lv.1", "x": 26.63, "y": 54.97 }
    ];

    const buffValues = {
      "Construction|Lv.1": "+5%",
      "Production|Lv.1": "+5%", 
      "Defense|Lv.2": "+8%",
      "Gathering|Lv.1": "+5%",
      "Tech|Lv.1": "+5%",
      "Weapons|Lv.2": "+8%",
      "Training|Lv.2": "+8%"
    };

    // === STATE ===
    const alliances = [];
    let calibrationSettings = {
      offsetX: 0,
      offsetY: 0.7,
      scaleX: 1.0,
      scaleY: 1.0
    };

    // === UTILITY FUNCTIONS ===
    function getRandomColor() {
      const colors = ['#d7263d', '#0074d9', '#2ecc71', '#ff851b', '#7fdbff', '#b10dc9'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('map-status');
      statusEl.textContent = message;
      statusEl.style.background = type === 'success' ? 'rgba(67, 233, 123, 0.2)' :
                                  type === 'error' ? 'rgba(220, 53, 69, 0.2)' :
                                  'rgba(79, 172, 254, 0.2)';
    }

    // === CALIBRATION FUNCTIONS ===
    function updateCalibrationFromInputs() {
      calibrationSettings.offsetX = parseFloat(document.getElementById('offsetX').value) || 0;
      calibrationSettings.offsetY = parseFloat(document.getElementById('offsetY').value) || 0;
      calibrationSettings.scaleX = parseFloat(document.getElementById('scaleX').value) || 1;
      calibrationSettings.scaleY = parseFloat(document.getElementById('scaleY').value) || 1;
    }

    function applyMarkerPosition(facility) {
      const adjustedX = (facility.x * calibrationSettings.scaleX) + calibrationSettings.offsetX;
      const adjustedY = (facility.y * calibrationSettings.scaleY) + calibrationSettings.offsetY;
      return { x: adjustedX, y: adjustedY };
    }

    function createMarker(facility, index) {
      const mapWrapper = document.getElementById('map-wrapper');
      if (!mapWrapper) return;

      const marker = document.createElement('div');
      marker.className = `marker ${facility.Type.toLowerCase()}`;
      
      const pos = applyMarkerPosition(facility);
      marker.style.left = `calc(${pos.x}% - 6px)`;
      marker.style.top = `calc(${pos.y}% - 6px)`;
      
      marker.title = `${facility.Type} ${facility.Level}${facility.ingameCoords ? ' (' + facility.ingameCoords + ')' : ''}`;
      marker.onclick = () => showDropdown(facility, marker, index);
      
      mapWrapper.appendChild(marker);
      facility.marker = marker;

      if (facility.Alliance) {
        renderAllianceIcon(facility);
        marker.classList.add('assigned');
      }
    }

    function recreateAllMarkers() {
      // Remove existing markers
      document.querySelectorAll('.marker').forEach(marker => marker.remove());
      
      // Create new markers with current calibration
      facilityData.forEach((facility, index) => {
        createMarker(facility, index);
      });
    }

    function highlightCastle() {
      const castle = facilityData.find(f => f.Type === "Castle");
      if (castle && castle.marker) {
        castle.marker.style.backgroundColor = 'red';
        castle.marker.style.width = '20px';
        castle.marker.style.height = '20px';
        castle.marker.style.zIndex = '1000';
        castle.marker.style.border = '3px solid yellow';
        showStatus('üè∞ Castello evidenziato in rosso. Verifica se √® allineato con la mappa.', 'info');
        
        setTimeout(() => {
          if (castle.marker) {
            castle.marker.style.backgroundColor = '';
            castle.marker.style.width = '';
            castle.marker.style.height = '';
            castle.marker.style.zIndex = '';
            castle.marker.style.border = '';
          }
        }, 5000);
      } else {
        showStatus('‚ùå Castello non trovato', 'error');
      }
    }

    function testCurrentCalibration() {
      updateCalibrationFromInputs();
      recreateAllMarkers();
      showStatus('üéØ Calibrazione testata. Controlla l\'allineamento dei marker.', 'info');
    }

    function applyCalibration() {
      updateCalibrationFromInputs();
      recreateAllMarkers();
      
      // Save to localStorage
      localStorage.setItem('whiteout-calibration', JSON.stringify(calibrationSettings));
      
      showStatus('‚úÖ Calibrazione applicata e salvata!', 'success');
    }

    function resetCalibration() {
      calibrationSettings = { offsetX: 0, offsetY: 0.7, scaleX: 1.0, scaleY: 1.0 };
      
      document.getElementById('offsetX').value = calibrationSettings.offsetX;
      document.getElementById('offsetY').value = calibrationSettings.offsetY;
      document.getElementById('scaleX').value = calibrationSettings.scaleX;
      document.getElementById('scaleY').value = calibrationSettings.scaleY;
      
      recreateAllMarkers();
      showStatus('üîÑ Calibrazione resettata', 'info');
    }

    function toggleCalibration() {
      const content = document.getElementById('calibration-content');
      const toggle = document.querySelector('.calibration-toggle');
      
      if (content.classList.contains('collapsed-content')) {
        content.classList.remove('collapsed-content');
        content.classList.add('expanded-content');
        toggle.textContent = '‚ñº';
      } else {
        content.classList.remove('expanded-content');
        content.classList.add('collapsed-content');
        toggle.textContent = '‚ñ∂';
      }
    }

    // === ALLIANCE MANAGEMENT ===
    function showDropdown(facility, marker, index) {
      if (alliances.length === 0) {
        showStatus('‚ö†Ô∏è Aggiungi almeno un\'alleanza prima di assegnare.', 'error');
        return;
      }

      closeAllDropdowns();

      const dropdown = document.createElement('select');
      dropdown.className = 'marker-dropdown';
      dropdown.innerHTML = `<option value="">-- Seleziona Alleanza --</option>` +
        alliances.map(a => `<option value="${a.name}" ${facility.Alliance === a.name ? "selected" : ""}>${a.name}</option>`).join("");
      
      dropdown.onchange = () => {
        facility.Alliance = dropdown.value;
        renderAllianceIcon(facility);
        
        if (dropdown.value) {
          marker.classList.add('assigned');
        } else {
          marker.classList.remove('assigned');
        }
        
        updateStats();
        updateSummaries();
        saveData();
        
        setTimeout(() => dropdown.remove(), 100);
      };

      dropdown.onblur = () => {
        setTimeout(() => {
          if (dropdown.parentNode) {
            dropdown.remove();
          }
        }, 300);
      };
      
      marker.appendChild(dropdown);
      dropdown.focus();
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.marker-dropdown').forEach(dropdown => dropdown.remove());
    }

    function renderAllianceIcon(facility) {
      if (!facility.marker) return;
      
      facility.marker.querySelectorAll('img').forEach(e => e.remove());
      
      const alliance = alliances.find(a => a.name === facility.Alliance);
      if (alliance) {
        const icon = document.createElement('img');
        icon.src = alliance.icon;
        icon.alt = `${facility.Alliance} icon`;
        facility.marker.appendChild(icon);
      }
    }

    function renderAllianceList() {
      const list = document.getElementById('alliance-list');
      list.innerHTML = '';
      
      alliances.forEach((alliance, index) => {
        const li = document.createElement('li');
        li.className = 'alliance-item';
        
        const assignedCount = facilityData.filter(f => f.Alliance === alliance.name).length;
        
        li.innerHTML = `
          <img src="${alliance.icon}" alt="${alliance.name}">
          <span class="alliance-name">${alliance.name}</span>
          <span style="font-size: 11px; color: var(--text-secondary);">${assignedCount} assegnate</span>
          <div class="alliance-actions">
            <button class="action-btn edit-btn" onclick="editAlliance(${index})">‚úèÔ∏è</button>
            <button class="action-btn delete-btn" onclick="deleteAlliance(${index})">üóëÔ∏è</button>
          </div>
        `;
        
        list.appendChild(li);
      });
    }

    function editAlliance(index) {
      // Simplified edit - just change name
      const alliance = alliances[index];
      const newName = prompt('Nuovo nome alleanza:', alliance.name);
      if (newName && newName.trim()) {
        const oldName = alliance.name;
        alliance.name = newName.trim();
        
        // Update facility assignments
        facilityData.forEach(f => {
          if (f.Alliance === oldName) {
            f.Alliance = newName.trim();
          }
        });
        
        renderAllianceList();
        updateSummaries();
        saveData();
      }
    }

    function deleteAlliance(index) {
      const alliance = alliances[index];
      const assignedCount = facilityData.filter(f => f.Alliance === alliance.name).length;
      
      let confirmMsg = `Eliminare "${alliance.name}"?`;
      if (assignedCount > 0) {
        confirmMsg += `\nAttenzione: ${assignedCount} strutture assegnate verranno liberate.`;
      }
      
      if (confirm(confirmMsg)) {
        // Remove assignments
        facilityData.forEach(f => {
          if (f.Alliance === alliance.name) {
            delete f.Alliance;
            if (f.marker) {
              renderAllianceIcon(f);
              f.marker.classList.remove('assigned');
            }
          }
        });
        
        alliances.splice(index, 1);
        renderAllianceList();
        updateStats();
        updateSummaries();
        saveData();
      }
    }

    // === UI UPDATES ===
    function updateStats() {
      document.getElementById('total-alliances').textContent = alliances.length;
      document.getElementById('assigned-facilities').textContent = 
        facilityData.filter(f => f.Alliance).length;
    }

    function updateSummaries() {
      renderFacilitySummary();
      renderBuffSummary();
    }

    function renderFacilitySummary() {
      const container = document.getElementById('facility-summary');
      
      const grouped = {};
      facilityData.forEach(f => {
        if (!grouped[f.Type]) grouped[f.Type] = [];
        grouped[f.Type].push(f);
      });
      
      let html = '';
      Object.entries(grouped).forEach(([type, facilities]) => {
        const assigned = facilities.filter(f => f.Alliance).length;
        html += `
          <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <strong>${type}</strong> (${assigned}/${facilities.length} assegnate)
            <div style="margin-top: 5px; font-size: 12px;">
              ${facilities.map(f => 
                `<span style="margin-right: 10px; ${f.Alliance ? 'color: #43e97b' : 'color: var(--text-secondary)'}">
                  ${f.Level}${f.Alliance ? ' ‚Üí ' + f.Alliance : ''}
                </span>`
              ).join('')}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html || '<p>Nessuna struttura caricata</p>';
    }

    function renderBuffSummary() {
      const container = document.getElementById('buff-summary');
      const byAlliance = {};

      facilityData.forEach(f => {
        if (!f.Alliance) return;
        if (!byAlliance[f.Alliance]) byAlliance[f.Alliance] = [];
        byAlliance[f.Alliance].push(f);
      });

      let html = '';
      Object.entries(byAlliance).forEach(([alliance, facilities]) => {
        const unique = new Set(facilities.map(f => `${f.Type}|${f.Level}`));
        const buffs = [...unique]
          .map(key => buffValues[key] ? `${buffValues[key]} ${key.split('|')[0]}` : null)
          .filter(Boolean)
          .join(', ');

        html += `
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <strong style="color: #43e97b;">${alliance}</strong><br>
            <span style="font-size: 14px; color: var(--text-secondary);">${buffs || 'Nessun buff riconosciuto'}</span>
            <div style="margin-top: 8px; font-size: 12px;">
              ${facilities.length} strutture: ${[...unique].join(', ')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html || '<p>Nessuna alleanza assegnata</p>';
    }

    function toggleSection(sectionId) {
      const content = document.getElementById(`${sectionId}-content`);
      const toggle = document.getElementById(`${sectionId.replace('-summary', '')}-toggle`);
      
      if (content.classList.contains('collapsed-content')) {
        content.classList.remove('collapsed-content');
        content.classList.add('expanded-content');
        toggle.textContent = '‚ñº';
        toggle.classList.remove('collapsed');
      } else {
        content.classList.remove('expanded-content');
        content.classList.add('collapsed-content');
        toggle.textContent = '‚ñ∂';
        toggle.classList.add('collapsed');
      }
    }

    // === DATA PERSISTENCE ===
    function saveData() {
      const data = {
        alliances: alliances,
        facilityAssignments: facilityData.map(f => ({
          Type: f.Type,
          Level: f.Level,
          x: f.x,
          y: f.y,
          Alliance: f.Alliance
        })),
        calibration: calibrationSettings
      };
      localStorage.setItem('whiteout-companion-data', JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem('whiteout-companion-data');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          
          if (data.alliances) {
            alliances.splice(0, alliances.length, ...data.alliances);
          }
          
          if (data.facilityAssignments) {
            data.facilityAssignments.forEach(saved => {
              const facility = facilityData.find(f => 
                f.Type === saved.Type && 
                f.Level === saved.Level && 
                Math.abs(f.x - saved.x) < 0.1 && 
                Math.abs(f.y - saved.y) < 0.1
              );
              if (facility && saved.Alliance) {
                facility.Alliance = saved.Alliance;
              }
            });
          }
          
          if (data.calibration) {
            calibrationSettings = data.calibration;
            document.getElementById('offsetX').value = calibrationSettings.offsetX;
            document.getElementById('offsetY').value = calibrationSettings.offsetY;
            document.getElementById('scaleX').value = calibrationSettings.scaleX;
            document.getElementById('scaleY').value = calibrationSettings.scaleY;
          }
        } catch (error) {
          console.error('Error loading data:', error);
        }
      }
    }

    // === EXPORT FUNCTIONS ===
    function exportCSV() {
      const csvContent = "Type,Level,X,Y,Alliance\n" + 
        facilityData.map(f => `${f.Type},${f.Level},${f.x},${f.y},${f.Alliance || ""}`).join("\n");
      
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "whiteout_facilities.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function exportPNG() {
      showStatus('üñºÔ∏è Funzione esportazione PNG in sviluppo', 'info');
    }

    // === EVENT LISTENERS ===
    document.getElementById('alliance-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const nameInput = document.getElementById('alliance-name');
      const name = nameInput.value.trim();
      const file = document.getElementById('alliance-icon').files[0];
      
      if (!name) {
        alert('Inserisci un nome per l\'alleanza');
        return;
      }
      
      if (alliances.find(a => a.name.toLowerCase() === name.toLowerCase())) {
        alert('Alleanza gi√† esistente');
        return;
      }
      
      if (alliances.length >= 50) {
        alert('Massimo 50 alleanze');
        return;
      }
      
      const processIcon = (iconData) => {
        alliances.push({ name, icon: iconData });
        renderAllianceList();
        updateStats();
        saveData();
        nameInput.value = '';
        document.getElementById('alliance-icon').value = '';
        showStatus(`‚úÖ Alleanza "${name}" creata!`, 'success');
      };
      
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => processIcon(evt.target.result);
        reader.readAsDataURL(file);
      } else {
        const defaultIcon = "data:image/svg+xml;base64," + btoa(`
          <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'>
            <circle cx='12' cy='12' r='12' fill='${getRandomColor()}'/>
            <text x='12' y='16' text-anchor='middle' fill='white' font-family='Arial' font-size='14' font-weight='bold'>
              ${name.charAt(0).toUpperCase()}
            </text>
          </svg>
        `);
        processIcon(defaultIcon);
      }
    });

    // Import CSV
    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const csv = evt.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          
          if (lines.length < 2) {
            alert("CSV vuoto o non valido");
            return;
          }
          
          // Clear existing assignments
          facilityData.forEach(f => delete f.Alliance);
          
          let importedCount = 0;
          const newAlliances = new Set();
          
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            
            if (values.length >= 5) {
              const [type, level, x, y, alliance] = values;
              
              if (alliance.trim()) {
                newAlliances.add(alliance.trim());
              }
              
              const facility = facilityData.find(f => 
                f.Type === type && 
                f.Level === level && 
                Math.abs(f.x - parseFloat(x)) < 0.1 && 
                Math.abs(f.y - parseFloat(y)) < 0.1
              );
              
              if (facility && alliance.trim()) {
                facility.Alliance = alliance.trim();
                importedCount++;
              }
            }
          }
          
          // Create missing alliances
          newAlliances.forEach(allianceName => {
            if (!alliances.find(a => a.name.toLowerCase() === allianceName.toLowerCase())) {
              const defaultIcon = "data:image/svg+xml;base64," + btoa(`
                <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'>
                  <circle cx='12' cy='12' r='12' fill='${getRandomColor()}'/>
                  <text x='12' y='16' text-anchor='middle' fill='white' font-family='Arial' font-size='14' font-weight='bold'>
                    ${allianceName.charAt(0).toUpperCase()}
                  </text>
                </svg>
              `);
              alliances.push({ name: allianceName, icon: defaultIcon });
            }
          });
          
          // Update UI
          facilityData.forEach(f => {
            if (f.marker) {
              renderAllianceIcon(f);
              if (f.Alliance) {
                f.marker.classList.add('assigned');
              } else {
                f.marker.classList.remove('assigned');
              }
            }
          });
          
          renderAllianceList();
          updateStats();
          updateSummaries();
          saveData();
          
          showStatus(`‚úÖ Importate ${importedCount} assegnazioni!`, 'success');
          
        } catch (error) {
          console.error("Import error:", error);
          alert("Errore nell'importazione del CSV");
        }
      };
      
      reader.readAsText(file);
      e.target.value = '';
    });

    // Auto-apply calibration as user types
    ['offsetX', 'offsetY', 'scaleX', 'scaleY'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        updateCalibrationFromInputs();
        recreateAllMarkers();
      });
    });

    // Close dropdowns when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.marker')) {
        closeAllDropdowns();
      }
    });

    // === INITIALIZATION ===
    document.addEventListener('DOMContentLoaded', () => {
      // Load saved data
      loadData();
      
      // Create initial markers
      facilityData.forEach((facility, index) => {
        createMarker(facility, index);
      });
      
      // Update UI
      renderAllianceList();
      updateStats();
      updateSummaries();
      
      showStatus('üéØ App caricata! Usa i controlli di calibrazione per allineare i marker.', 'success');
      
      console.log('=== WHITEOUT COMPANION ===');
      console.log('Calibrazione caricata:', calibrationSettings);
      console.log('Strutture caricate:', facilityData.length);
      console.log('Alleanze caricate:', alliances.length);
    });
    
    // Make functions globally accessible for debugging
    window.highlightCastle = highlightCastle;
    window.testCurrentCalibration = testCurrentCalibration;
    window.applyCalibration = applyCalibration;
    window.resetCalibration = resetCalibration;
  </script>
</body>
</html>
