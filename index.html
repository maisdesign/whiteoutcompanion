<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="theme-color" content="#1e3c72">
  <meta name="description" content="Professional alliance management tool for Whiteout Survival">
  
  <title>Whiteout Survival Companion</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* Base Styles */
    :root {
      --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --glass-bg: rgba(255, 255, 255, 0.1);
      --glass-border: rgba(255, 255, 255, 0.2);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.8);
      --spacing-md: 16px;
      --radius-md: 12px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 2.5rem;
      margin-bottom: 10px;
      font-weight: 700;
      text-align: center;
    }

    .header p {
      text-align: center;
      color: var(--text-secondary);
      margin: 0 auto;
    }

    .glass-card {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
    }

    .app-layout {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 30px;
      align-items: start;
    }

    .sidebar {
      background: var(--glass-bg);
      backdrop-filter: blur(20px);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-md);
      padding: 20px;
    }

    .main-content {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: white;
    }

    .btn-warning {
      background: linear-gradient(135deg, #ffd89b 0%, #19547b 100%);
      color: white;
    }

    .btn-success {
      background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
      color: white;
    }

    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
    }

    /* Alliance Form */
    .alliance-form {
      margin-bottom: 20px;
    }

    .alliance-form input {
      width: 100%;
      padding: 12px;
      border: 2px solid var(--glass-border);
      border-radius: 8px;
      background: var(--glass-bg);
      color: var(--text-primary);
      margin-bottom: 12px;
      backdrop-filter: blur(10px);
    }

    .alliance-form input::placeholder {
      color: var(--text-secondary);
    }

    .alliance-form input[type="file"] {
      padding: 8px;
      border-style: dashed;
    }

    /* Alliance List */
    .alliance-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .alliance-item {
      background: rgba(255, 255, 255, 0.08);
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid var(--glass-border);
      display: flex;
      align-items: center;
      gap: 12px;
      transition: all 0.3s ease;
    }

    .alliance-item:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 0.12);
    }

    .alliance-item img {
      width: 24px;
      height: 24px;
      border-radius: 50%;
    }

    .alliance-name {
      flex: 1;
      font-weight: 500;
    }

    .alliance-actions {
      display: flex;
      gap: 5px;
    }

    .action-btn {
      background: none;
      border: none;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      transition: background-color 0.2s;
    }

    .edit-btn:hover {
      background: rgba(255, 193, 7, 0.2);
    }

    .delete-btn:hover {
      background: rgba(220, 53, 69, 0.2);
    }

    /* Map Container */
    .map-container {
      position: relative;
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(255, 255, 255, 0.05);
      padding: 20px;
    }

    .map-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .map-status {
      background: rgba(79, 172, 254, 0.2);
      border: 1px solid rgba(79, 172, 254, 0.5);
      padding: 10px 15px;
      border-radius: 8px;
      font-size: 14px;
      margin-bottom: 15px;
    }

    .map-wrapper {
      position: relative;
      border-radius: 10px;
      overflow: hidden;
    }

    #map {
      width: 100%;
      height: auto;
      display: block;
      cursor: crosshair;
    }

    .marker {
      position: absolute;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid white;
      cursor: pointer;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      z-index: 10;
    }

    .marker:hover {
      transform: scale(1.5);
      z-index: 20;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
    }

    /* COLORI UFFICIALI CORRETTI */
    .marker.castle { 
      background: #FFD700;
      border: 3px solid #FF4500;
      width: 16px;
      height: 16px;
      box-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
    }

    .marker.construction { 
      background: #1274e2;
      border-color: #0d5bb8;
    }

    .marker.production { 
      background: #40df0c;
      border-color: #2fb309;
    }

    .marker.defense { 
      background: #00a584;
      border-color: #008066;
    }

    .marker.gathering { 
      background: #c912dd;
      border-color: #a00eb8;
    }

    .marker.tech { 
      background: #e47c0b;
      border-color: #b86209;
    }

    .marker.weapons { 
      background: #e4240c;
      border-color: #b81d0a;
    }

    .marker.training { 
      background: #e5e003;
      border-color: #b8b803;
    }

    .marker.expedition { 
      background: #f944ca;
      border-color: #c7369f;
    }

    .marker.stronghold { 
      background: #8B4513;
      border-color: #A0522D;
    }

    .marker.fortress { 
      background: #2F2F2F;
      border-color: #000000;
    }

    .marker.assigned {
      box-shadow: 0 0 12px rgba(67, 233, 123, 0.8);
      border-width: 3px;
    }

    .marker.assigned:hover {
      box-shadow: 0 0 15px rgba(67, 233, 123, 1);
    }

    .marker img {
      position: absolute;
      left: 50%;
      top: 0;
      width: 20px;
      height: 20px;
      transform: translate(-50%, -100%);
      z-index: 11;
      pointer-events: none;
      border-radius: 50%;
      border: 1px solid rgba(255,255,255,0.9);
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
      background: white;
    }

    .marker-dropdown {
      position: absolute;
      top: 120%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 2000;
      background: rgba(30, 30, 30, 0.95);
      backdrop-filter: blur(20px);
      border: 2px solid #4facfe;
      border-radius: 12px;
      padding: 8px;
      min-width: 180px;
      max-width: 220px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.6);
      animation: dropdownOpen 0.2s ease;
    }

    .marker-dropdown.dropdown-above {
      top: auto;
      bottom: 120%;
    }

    @keyframes dropdownOpen {
      from { opacity: 0; transform: translateX(-50%) scale(0.9); }
      to { opacity: 1; transform: translateX(-50%) scale(1); }
    }

    @keyframes fadeOut {
      from { opacity: 1; transform: translateX(-50%) scale(1); }
      to { opacity: 0; transform: translateX(-50%) scale(0.9); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .dropdown-header {
      background: rgba(79, 172, 254, 0.3);
      padding: 8px 12px;
      margin: -8px -8px 8px -8px;
      border-radius: 8px 8px 0 0;
      font-size: 12px;
      font-weight: 600;
      color: #FFFFFF;
      border-bottom: 1px solid rgba(79, 172, 254, 0.5);
    }

    .dropdown-option {
      padding: 10px 12px;
      cursor: pointer;
      border-radius: 6px;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #FFFFFF;
      border: 1px solid transparent;
      margin-bottom: 2px;
    }

    .dropdown-option:hover {
      background: rgba(79, 172, 254, 0.3);
      border-color: rgba(79, 172, 254, 0.6);
      transform: translateX(2px);
    }

    .dropdown-option.selected {
      background: rgba(67, 233, 123, 0.3);
      border-color: rgba(67, 233, 123, 0.6);
      color: #FFFFFF;
      font-weight: 600;
    }

    .dropdown-option.unassign {
      color: #FF6B6B;
      font-style: italic;
    }

    .dropdown-option.unassign:hover {
      background: rgba(255, 107, 107, 0.3);
      border-color: rgba(255, 107, 107, 0.6);
    }

    .alliance-icon-small {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: white;
      flex-shrink: 0;
    }

    /* Controls */
    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.05);
      border-radius: var(--radius-md);
      padding: 15px;
      text-align: center;
      border: 1px solid var(--glass-border);
      transition: all 0.3s ease;
    }

    .stat-card:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateY(-2px);
    }

    .stat-number {
      font-size: 1.8rem;
      font-weight: 700;
      color: #4facfe;
      margin-bottom: 4px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Summary Sections */
    .summary-section {
      margin-bottom: 20px;
      padding: 20px;
    }

    .summary-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      cursor: pointer;
      padding: 5px;
      border-radius: 8px;
      transition: background-color 0.2s;
    }

    .summary-header:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .section-toggle {
      font-size: 14px;
      color: var(--text-secondary);
      transition: transform 0.3s ease;
    }

    .section-toggle.collapsed {
      transform: rotate(-90deg);
    }

    .summary-content {
      overflow: hidden;
      transition: all 0.3s ease;
    }

    /* Calibration Section */
    .calibration-section {
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      padding: 20px;
      border-radius: var(--radius-md);
      margin-top: 40px;
    }

    .calibration-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .calibration-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
      padding: 5px;
    }

    .calibration-controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 15px;
    }

    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .control-group label {
      font-size: 12px;
      font-weight: bold;
      color: var(--text-secondary);
    }

    .control-group input {
      padding: 8px 12px;
      border: none;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      font-size: 14px;
    }

    .calibration-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .password-section {
      background: rgba(255, 0, 0, 0.1);
      border: 1px solid rgba(255, 0, 0, 0.3);
      padding: 15px;
      border-radius: var(--radius-md);
      margin-bottom: 15px;
      text-align: center;
    }

    .password-input {
      padding: 8px 12px;
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      margin: 0 10px;
    }

    .password-input::placeholder {
      color: var(--text-secondary);
    }

    /* Legend Styles */
    .map-legend {
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(10px);
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .legend-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }

    .legend-marker {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid white;
      flex-shrink: 0;
    }

    .legend-marker.castle { background: #FFD700; border-color: #FF4500; }
    .legend-marker.construction { background: #1274e2; border-color: #0d5bb8; }
    .legend-marker.production { background: #40df0c; border-color: #2fb309; }
    .legend-marker.defense { background: #00a584; border-color: #008066; }
    .legend-marker.gathering { background: #c912dd; border-color: #a00eb8; }
    .legend-marker.tech { background: #e47c0b; border-color: #b86209; }
    .legend-marker.weapons { background: #e4240c; border-color: #b81d0a; }
    .legend-marker.training { background: #e5e003; border-color: #b8b803; }
    .legend-marker.expedition { background: #f944ca; border-color: #c7369f; }
    .legend-marker.stronghold { background: #8B4513; border-color: #A0522D; }
    .legend-marker.fortress { background: #2F2F2F; border-color: #000000; }

    /* Responsive */
    @media (max-width: 1024px) {
      .app-layout { grid-template-columns: 1fr; }
      .calibration-controls { grid-template-columns: repeat(2, 1fr); }
    }

    @media (max-width: 768px) {
      .container { padding: 10px; }
      .header h1 { font-size: 2rem; }
      .calibration-controls { grid-template-columns: 1fr; }
      .calibration-buttons { flex-direction: column; }
      .controls { flex-direction: column; }
      .stats-grid { grid-template-columns: repeat(2, 1fr); }
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid rgba(255,255,255,0.1);
      border-left: 4px solid #4facfe;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .hidden { display: none; }
    .collapsed-content { max-height: 0; overflow: hidden; }
    .expanded-content { max-height: 2000px; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <h1 id="main-title">üó∫Ô∏è Whiteout Survival Companion</h1>
      <p id="main-subtitle">Professional alliance management with map calibration</p>
    </div>

    <!-- App Layout -->
    <div class="app-layout">
      
      <!-- Sidebar -->
      <aside class="sidebar glass-card">
        <!-- Quick Stats -->
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number" id="total-alliances">0</div>
            <div class="stat-label" id="alliances-label">Alleanze</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="assigned-facilities">0</div>
            <div class="stat-label" id="assigned-label">Assegnate</div>
          </div>
        </div>

        <!-- Alliance Form -->
        <h3 id="alliance-management-title">üè∞ Gestione Alleanze</h3>
        <form class="alliance-form" id="alliance-form">
          <input type="text" id="alliance-name" placeholder="Nome alleanza..." maxlength="30" required>
          <input type="file" id="alliance-icon" accept="image/*">
          <button type="submit" class="btn btn-primary" style="width: 100%;" id="add-alliance-btn">
            ‚ú® Aggiungi Alleanza
          </button>
        </form>

        <!-- Alliance List -->
        <ul class="alliance-list" id="alliance-list"></ul>
      </aside>

      <!-- Main Content -->
      <main class="main-content">
        
        <!-- Controls -->
        <div class="controls">
          <button class="btn btn-success" onclick="exportCSV()" id="export-csv-btn">üìä Esporta CSV</button>
          <button class="btn btn-info" onclick="exportPNG()" id="export-png-btn">üñºÔ∏è Esporta PNG</button>
          <input type="file" id="import-file" accept=".csv" style="display: none;">
          <button class="btn btn-primary" onclick="document.getElementById('import-file').click()" id="import-csv-btn">üì• Importa CSV</button>
          <button class="btn btn-warning" onclick="toggleLanguageSelector()" id="language-btn">üåê Lingua</button>
        </div>

        <!-- Language Selector -->
        <div id="language-selector" class="glass-card hidden" style="padding: 15px; margin-bottom: 20px;">
          <h4 style="margin-bottom: 10px;" id="select-language-title">üåê Seleziona Lingua</h4>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
            <button class="btn btn-info" onclick="setLanguage('en')" id="lang-en">üá∫üá∏ English</button>
            <button class="btn btn-info" onclick="setLanguage('it')" id="lang-it">üáÆüáπ Italiano</button>
            <button class="btn btn-info" onclick="setLanguage('es')" id="lang-es">üá™üá∏ Espa√±ol</button>
            <button class="btn btn-info" onclick="setLanguage('fr')" id="lang-fr">üá´üá∑ Fran√ßais</button>
            <button class="btn btn-info" onclick="setLanguage('de')" id="lang-de">üá©üá™ Deutsch</button>
            <button class="btn btn-info" onclick="setLanguage('pt')" id="lang-pt">üáµüáπ Portugu√™s</button>
          </div>
        </div>

        <!-- Map Container -->
        <section class="map-container glass-card">
          <div class="map-header">
            <h3 id="map-title">üó∫Ô∏è Mappa Interattiva</h3>
            <button class="btn btn-info" onclick="toggleLegend()" style="font-size: 12px;" id="legend-btn">üé® Legenda</button>
          </div>
          
          <!-- Legend -->
          <div id="map-legend" class="map-legend hidden">
            <h4 id="legend-title">üé® Legenda Colori Ufficiali</h4>
            <div class="legend-grid">
              <div class="legend-item"><div class="legend-marker castle"></div> <span id="color-castle">Castle (Oro)</span></div>
              <div class="legend-item"><div class="legend-marker construction"></div> <span id="color-construction">Construction (Blu)</span></div>
              <div class="legend-item"><div class="legend-marker production"></div> <span id="color-production">Production (Verde)</span></div>
              <div class="legend-item"><div class="legend-marker defense"></div> <span id="color-defense">Defense (Verde Acqua)</span></div>
              <div class="legend-item"><div class="legend-marker gathering"></div> <span id="color-gathering">Gathering (Viola)</span></div>
              <div class="legend-item"><div class="legend-marker tech"></div> <span id="color-tech">Research/Tech (Arancione)</span></div>
              <div class="legend-item"><div class="legend-marker weapons"></div> <span id="color-weapons">Troop Attack (Rosso)</span></div>
              <div class="legend-item"><div class="legend-marker training"></div> <span id="color-training">Training (Giallo)</span></div>
              <div class="legend-item"><div class="legend-marker expedition"></div> <span id="color-expedition">March/Expedition (Rosa)</span></div>
              <div class="legend-item"><div class="legend-marker stronghold"></div> <span id="color-stronghold">Stronghold (Marrone)</span></div>
              <div class="legend-item"><div class="legend-marker fortress"></div> <span id="color-fortress">Fortress (Grigio Scuro)</span></div>
            </div>
          </div>
          
          <div class="map-status" id="map-status">
            Marker con colori ufficiali: Blu=Construction, Verde=Production, Verde Acqua=Defense, Viola=Gathering, Arancione=Tech, Rosso=Attack, Giallo=Training, Rosa=March. Clicca per assegnare alle alleanze.
          </div>
          
          <div class="map-wrapper" id="map-wrapper">
            <img src="assets/map.png" id="map" alt="Whiteout Survival Map" 
                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAwIiBoZWlnaHQ9IjYwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjNDQ0Ii8+PHRleHQgeD0iNTAlIiB5PSI0NSUiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyNCIgZmlsbD0iI2ZmZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPk1hcHBhIGRlbCBHaW9jbzwvdGV4dD48dGV4dCB4PSI1MCUiIHk9IjU1JSIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE0IiBmaWxsPSIjY2NjIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+U29zdGl0dWlyZSBjb24gbGEgbWFwcGEgdmVyYSAoYXNzZXRzL21hcC5wbmcpPC90ZXh0Pjwvc3ZnPic;">
          </div>
        </section>

        <!-- Summary Sections -->
        <section class="summary-section glass-card">
          <div class="summary-header" onclick="toggleSection('facility-summary')">
            <h3 id="facility-summary-title">üìã Riepilogo Strutture</h3>
            <span class="section-toggle" id="facility-toggle">‚ñº</span>
          </div>
          <div id="facility-summary-content" class="summary-content expanded-content">
            <div id="facility-summary"></div>
          </div>
        </section>

        <section class="summary-section glass-card">
          <div class="summary-header" onclick="toggleSection('buff-summary')">
            <h3 id="buff-summary-title">‚ö° Riepilogo Buff</h3>
            <span class="section-toggle" id="buff-toggle">‚ñº</span>
          </div>
          <div id="buff-summary-content" class="summary-content expanded-content">
            <div id="buff-summary"></div>
          </div>
        </section>

        <!-- Calibration Section -->
        <section class="calibration-section glass-card">
          <div class="calibration-header">
            <h3 id="calibration-title">üîß Calibrazione Avanzata</h3>
            <button class="calibration-toggle" onclick="toggleCalibration()">‚ñ∂</button>
          </div>
          
          <div id="calibration-content" class="collapsed-content">
            <!-- Password Protection -->
            <div class="password-section" id="password-section">
              <p style="color: #ff6b6b; margin-bottom: 10px;">üîí Sezione protetta - Solo per utenti avanzati</p>
              <input type="password" id="calibration-password" class="password-input" placeholder="Inserisci password...">
              <button class="btn btn-warning" onclick="checkCalibrationPassword()">üîì Sblocca</button>
            </div>
            
            <!-- Calibration Controls -->
            <div id="calibration-controls-section" class="hidden">
              <div class="calibration-controls">
                <div class="control-group">
                  <label>Offset X:</label>
                  <input type="number" id="offsetX" value="0" step="0.1">
                </div>
                <div class="control-group">
                  <label>Offset Y:</label>
                  <input type="number" id="offsetY" value="0.7" step="0.1">
                </div>
                <div class="control-group">
                  <label>Scala X:</label>
                  <input type="number" id="scaleX" value="1" step="0.01" min="0.5" max="2">
                </div>
                <div class="control-group">
                  <label>Scala Y:</label>
                  <input type="number" id="scaleY" value="1" step="0.01" min="0.5" max="2">
                </div>
              </div>
              
              <div class="calibration-buttons">
                <button class="btn btn-info" onclick="highlightCastle()">üè∞ Evidenzia Castello</button>
                <button class="btn btn-warning" onclick="testCurrentCalibration()">üéØ Test Calibrazione</button>
                <button class="btn btn-success" onclick="applyCalibration()">‚úÖ Applica</button>
                <button class="btn btn-primary" onclick="resetCalibration()">üîÑ Reset</button>
                <button class="btn btn-primary" onclick="debugMarkers()" style="font-size: 12px;">üîç Debug</button>
              </div>
            </div>
          </div>
        </section>

      </main>
    </div>
  </div>

  <script>
    // === TRADUZIONI COMPLETE ===
    const translations = {
      it: {
        title: "üó∫Ô∏è Whiteout Survival Companion",
        subtitle: "Gestione professionale alleanze con calibrazione mappa",
        alliances: "Alleanze",
        assigned: "Assegnate",
        allianceManagement: "üè∞ Gestione Alleanze",
        allianceName: "Nome alleanza...",
        addAlliance: "‚ú® Aggiungi Alleanza",
        exportCSV: "üìä Esporta CSV",
        exportPNG: "üñºÔ∏è Esporta PNG",
        importCSV: "üì• Importa CSV",
        language: "üåê Lingua",
        selectLanguage: "üåê Seleziona Lingua",
        interactiveMap: "üó∫Ô∏è Mappa Interattiva",
        legend: "üé® Legenda",
        legendTitle: "üé® Legenda Colori Ufficiali",
        facilitySummary: "üìã Riepilogo Strutture",
        buffSummary: "‚ö° Riepilogo Buff",
        advancedCalibration: "üîß Calibrazione Avanzata",
        unassigned: "‚ùå Non assegnata",
        // Colori
        colorCastle: "Castle (Oro)",
        colorConstruction: "Construction (Blu)",
        colorProduction: "Production (Verde)",
        colorDefense: "Defense (Verde Acqua)",
        colorGathering: "Gathering (Viola)",
        colorTech: "Research/Tech (Arancione)",
        colorWeapons: "Troop Attack (Rosso)",
        colorTraining: "Training (Giallo)",
        colorExpedition: "March/Expedition (Rosa)",
        colorStronghold: "Stronghold (Marrone)",
        colorFortress: "Fortress (Grigio Scuro)",
        // Messaggi
        noStructuresLoaded: "Nessuna struttura caricata",
        noAllianceAssigned: "Nessuna alleanza assegnata",
        noBuffRecognized: "Nessun buff riconosciuto",
        structures: "strutture",
        addAtLeastOneAlliance: "‚ö†Ô∏è Aggiungi almeno un'alleanza prima di assegnare.",
        enterAllianceName: "Inserisci un nome per l'alleanza",
        allianceExists: "Alleanza gi√† esistente",
        maxAlliances: "Massimo 50 alleanze",
        emptyCsv: "CSV vuoto o non valido",
        importError: "Errore nell'importazione del CSV",
        languageSet: "üåê Lingua impostata!",
        calibrationUnlocked: "üîì Calibrazione sbloccata!",
        wrongPassword: "‚ùå Password errata!",
        appLoaded: "üéØ App caricata! {count} strutture con colori ufficiali.",
        assigned: "assegnate"
      },
      en: {
        title: "üó∫Ô∏è Whiteout Survival Companion",
        subtitle: "Professional alliance management with map calibration",
        alliances: "Alliances",
        assigned: "Assigned",
        allianceManagement: "üè∞ Alliance Management",
        allianceName: "Alliance name...",
        addAlliance: "‚ú® Add Alliance",
        exportCSV: "üìä Export CSV",
        exportPNG: "üñºÔ∏è Export PNG",
        importCSV: "üì• Import CSV",
        language: "üåê Language",
        selectLanguage: "üåê Select Language",
        interactiveMap: "üó∫Ô∏è Interactive Map",
        legend: "üé® Legend",
        legendTitle: "üé® Official Colors Legend",
        facilitySummary: "üìã Facility Summary",
        buffSummary: "‚ö° Buff Summary",
        advancedCalibration: "üîß Advanced Calibration",
        unassigned: "‚ùå Unassigned",
        // Colori
        colorCastle: "Castle (Gold)",
        colorConstruction: "Construction (Blue)",
        colorProduction: "Production (Green)",
        colorDefense: "Defense (Teal)",
        colorGathering: "Gathering (Purple)",
        colorTech: "Research/Tech (Orange)",
        colorWeapons: "Troop Attack (Red)",
        colorTraining: "Training (Yellow)",
        colorExpedition: "March/Expedition (Pink)",
        colorStronghold: "Stronghold (Brown)",
        colorFortress: "Fortress (Dark Gray)",
        // Messaggi
        noStructuresLoaded: "No structures loaded",
        noAllianceAssigned: "No alliance assigned",
        noBuffRecognized: "No buff recognized",
        structures: "structures",
        addAtLeastOneAlliance: "‚ö†Ô∏è Add at least one alliance before assigning.",
        enterAllianceName: "Enter an alliance name",
        allianceExists: "Alliance already exists",
        maxAlliances: "Maximum 50 alliances",
        emptyCsv: "Empty or invalid CSV",
        importError: "Error importing CSV",
        languageSet: "üåê Language set!",
        calibrationUnlocked: "üîì Calibration unlocked!",
        wrongPassword: "‚ùå Wrong password!",
        appLoaded: "üéØ App loaded! {count} structures with official colors.",
        assigned: "assigned"
      },
      es: {
        title: "üó∫Ô∏è Whiteout Survival Companion",
        subtitle: "Gesti√≥n profesional de alianzas con calibraci√≥n de mapa",
        alliances: "Alianzas",
        assigned: "Asignadas",
        allianceManagement: "üè∞ Gesti√≥n de Alianzas",
        allianceName: "Nombre de alianza...",
        addAlliance: "‚ú® Agregar Alianza",
        exportCSV: "üìä Exportar CSV",
        exportPNG: "üñºÔ∏è Exportar PNG",
        importCSV: "üì• Importar CSV",
        language: "üåê Idioma",
        selectLanguage: "üåê Seleccionar Idioma",
        interactiveMap: "üó∫Ô∏è Mapa Interactivo",
        legend: "üé® Leyenda",
        legendTitle: "üé® Leyenda Colores Oficiales",
        facilitySummary: "üìã Resumen de Instalaciones",
        buffSummary: "‚ö° Resumen de Buff",
        advancedCalibration: "üîß Calibraci√≥n Avanzada",
        unassigned: "‚ùå Sin asignar",
        // Colori
        colorCastle: "Castle (Oro)",
        colorConstruction: "Construction (Azul)",
        colorProduction: "Production (Verde)",
        colorDefense: "Defense (Verde Agua)",
        colorGathering: "Gathering (P√∫rpura)",
        colorTech: "Research/Tech (Naranja)",
        colorWeapons: "Troop Attack (Rojo)",
        colorTraining: "Training (Amarillo)",
        colorExpedition: "March/Expedition (Rosa)",
        colorStronghold: "Stronghold (Marr√≥n)",
        colorFortress: "Fortress (Gris Oscuro)",
        // Messaggi
        noStructuresLoaded: "No hay estructuras cargadas",
        noAllianceAssigned: "No hay alianza asignada",
        noBuffRecognized: "No hay buff reconocido",
        structures: "estructuras",
        addAtLeastOneAlliance: "‚ö†Ô∏è Agrega al menos una alianza antes de asignar.",
        enterAllianceName: "Ingresa un nombre de alianza",
        allianceExists: "La alianza ya existe",
        maxAlliances: "M√°ximo 50 alianzas",
        emptyCsv: "CSV vac√≠o o inv√°lido",
        importError: "Error al importar CSV",
        languageSet: "üåê ¬°Idioma establecido!",
        calibrationUnlocked: "üîì ¬°Calibraci√≥n desbloqueada!",
        wrongPassword: "‚ùå ¬°Contrase√±a incorrecta!",
        appLoaded: "üéØ ¬°App cargada! {count} estructuras con colores oficiales.",
        assigned: "asignadas"
      },
      fr: {
        title: "üó∫Ô∏è Whiteout Survival Companion",
        subtitle: "Gestion professionnelle d'alliances avec calibrage de carte",
        alliances: "Alliances",
        assigned: "Assign√©es",
        allianceManagement: "üè∞ Gestion des Alliances",
        allianceName: "Nom d'alliance...",
        addAlliance: "‚ú® Ajouter Alliance",
        exportCSV: "üìä Exporter CSV",
        exportPNG: "üñºÔ∏è Exporter PNG",
        importCSV: "üì• Importer CSV",
        language: "üåê Langue",
        selectLanguage: "üåê S√©lectionner la Langue",
        interactiveMap: "üó∫Ô∏è Carte Interactive",
        legend: "üé® L√©gende",
        legendTitle: "üé® L√©gende Couleurs Officielles",
        facilitySummary: "üìã R√©sum√© des Installations",
        buffSummary: "‚ö° R√©sum√© des Buff",
        advancedCalibration: "üîß Calibrage Avanc√©",
        unassigned: "‚ùå Non assign√©e",
        // Colori
        colorCastle: "Castle (Or)",
        colorConstruction: "Construction (Bleu)",
        colorProduction: "Production (Vert)",
        colorDefense: "Defense (Vert d'Eau)",
        colorGathering: "Gathering (Violet)",
        colorTech: "Research/Tech (Orange)",
        colorWeapons: "Troop Attack (Rouge)",
        colorTraining: "Training (Jaune)",
        colorExpedition: "March/Expedition (Rose)",
        colorStronghold: "Stronghold (Marron)",
        colorFortress: "Fortress (Gris Fonc√©)",
        // Messaggi
        noStructuresLoaded: "Aucune structure charg√©e",
        noAllianceAssigned: "Aucune alliance assign√©e",
        noBuffRecognized: "Aucun buff reconnu",
        structures: "structures",
        addAtLeastOneAlliance: "‚ö†Ô∏è Ajoutez au moins une alliance avant d'assigner.",
        enterAllianceName: "Entrez un nom d'alliance",
        allianceExists: "L'alliance existe d√©j√†",
        maxAlliances: "Maximum 50 alliances",
        emptyCsv: "CSV vide ou invalide",
        importError: "Erreur lors de l'importation CSV",
        languageSet: "üåê Langue d√©finie !",
        calibrationUnlocked: "üîì Calibrage d√©bloqu√© !",
        wrongPassword: "‚ùå Mot de passe incorrect !",
        appLoaded: "üéØ App charg√©e ! {count} structures avec couleurs officielles.",
        assigned: "assign√©es"
      },
      de: {
        title: "üó∫Ô∏è Whiteout Survival Companion",
        subtitle: "Professionelle Allianz-Verwaltung mit Kartenkalibrierung",
        alliances: "Allianzen",
        assigned: "Zugewiesen",
        allianceManagement: "üè∞ Allianz-Verwaltung",
        allianceName: "Allianzname...",
        addAlliance: "‚ú® Allianz Hinzuf√ºgen",
        exportCSV: "üìä CSV Exportieren",
        exportPNG: "üñºÔ∏è PNG Exportieren",
        importCSV: "üì• CSV Importieren",
        language: "üåê Sprache",
        selectLanguage: "üåê Sprache Ausw√§hlen",
        interactiveMap: "üó∫Ô∏è Interaktive Karte",
        legend: "üé® Legende",
        legendTitle: "üé® Offizielle Farben Legende",
        facilitySummary: "üìã Anlagen-Zusammenfassung",
        buffSummary: "‚ö° Buff-Zusammenfassung",
        advancedCalibration: "üîß Erweiterte Kalibrierung",
        unassigned: "‚ùå Nicht zugewiesen",
        // Colori
        colorCastle: "Castle (Gold)",
        colorConstruction: "Construction (Blau)",
        colorProduction: "Production (Gr√ºn)",
        colorDefense: "Defense (T√ºrkis)",
        colorGathering: "Gathering (Lila)",
        colorTech: "Research/Tech (Orange)",
        colorWeapons: "Troop Attack (Rot)",
        colorTraining: "Training (Gelb)",
        colorExpedition: "March/Expedition (Rosa)",
        colorStronghold: "Stronghold (Braun)",
        colorFortress: "Fortress (Dunkelgrau)",
        // Messaggi
        noStructuresLoaded: "Keine Strukturen geladen",
        noAllianceAssigned: "Keine Allianz zugewiesen",
        noBuffRecognized: "Kein Buff erkannt",
        structures: "Strukturen",
        addAtLeastOneAlliance: "‚ö†Ô∏è F√ºgen Sie mindestens eine Allianz hinzu, bevor Sie zuweisen.",
        enterAllianceName: "Geben Sie einen Allianznamen ein",
        allianceExists: "Allianz existiert bereits",
        maxAlliances: "Maximal 50 Allianzen",
        emptyCsv: "Leere oder ung√ºltige CSV",
        importError: "Fehler beim CSV-Import",
        languageSet: "üåê Sprache eingestellt!",
        calibrationUnlocked: "üîì Kalibrierung freigeschaltet!",
        wrongPassword: "‚ùå Falsches Passwort!",
        appLoaded: "üéØ App geladen! {count} Strukturen mit offiziellen Farben.",
        assigned: "zugewiesen"
      },
      pt: {
        title: "üó∫Ô∏è Whiteout Survival Companion",
        subtitle: "Gest√£o profissional de alian√ßas com calibra√ß√£o de mapa",
        alliances: "Alian√ßas",
        assigned: "Atribu√≠das",
        allianceManagement: "üè∞ Gest√£o de Alian√ßas",
        allianceName: "Nome da alian√ßa...",
        addAlliance: "‚ú® Adicionar Alian√ßa",
        exportCSV: "üìä Exportar CSV",
        exportPNG: "üñºÔ∏è Exportar PNG",
        importCSV: "üì• Importar CSV",
        language: "üåê Idioma",
        selectLanguage: "üåê Selecionar Idioma",
        interactiveMap: "üó∫Ô∏è Mapa Interativo",
        legend: "üé® Legenda",
        legendTitle: "üé® Legenda Cores Oficiais",
        facilitySummary: "üìã Resumo de Instala√ß√µes",
        buffSummary: "‚ö° Resumo de Buff",
        advancedCalibration: "üîß Calibra√ß√£o Avan√ßada",
        unassigned: "‚ùå N√£o atribu√≠da",
        // Colori
        colorCastle: "Castle (Ouro)",
        colorConstruction: "Construction (Azul)",
        colorProduction: "Production (Verde)",
        colorDefense: "Defense (Verde √Ågua)",
        colorGathering: "Gathering (Roxo)",
        colorTech: "Research/Tech (Laranja)",
        colorWeapons: "Troop Attack (Vermelho)",
        colorTraining: "Training (Amarelo)",
        colorExpedition: "March/Expedition (Rosa)",
        colorStronghold: "Stronghold (Marrom)",
        colorFortress: "Fortress (Cinza Escuro)",
        // Messaggi
        noStructuresLoaded: "Nenhuma estrutura carregada",
        noAllianceAssigned: "Nenhuma alian√ßa atribu√≠da",
        noBuffRecognized: "Nenhum buff reconhecido",
        structures: "estruturas",
        addAtLeastOneAlliance: "‚ö†Ô∏è Adicione pelo menos uma alian√ßa antes de atribuir.",
        enterAllianceName: "Digite um nome de alian√ßa",
        allianceExists: "Alian√ßa j√° existe",
        maxAlliances: "M√°ximo 50 alian√ßas",
        emptyCsv: "CSV vazio ou inv√°lido",
        importError: "Erro ao importar CSV",
        languageSet: "üåê Idioma definido!",
        calibrationUnlocked: "üîì Calibra√ß√£o desbloqueada!",
        wrongPassword: "‚ùå Senha incorreta!",
        appLoaded: "üéØ App carregado! {count} estruturas com cores oficiais.",
        assigned: "atribu√≠das"
      }
    };

    // === DATI ===
    const facilityData = [
      { "Type": "Castle", "Level": "Lv.1", "x": 50.06, "y": 48.79, "ingameCoords": "X:597 Y:597" },
      { "Type": "Construction", "Level": "Lv.1", "x": 50.19, "y": 12.48, "ingameCoords": "X:168 Y:168" },
      { "Type": "Construction", "Level": "Lv.1", "x": 66.19, "y": 70.48, "ingameCoords": "X:537 Y:138" },
      { "Type": "Construction", "Level": "Lv.1", "x": 87.19, "y": 49.32, "ingameCoords": "X:1068 X:138" },
      { "Type": "Construction", "Level": "Lv.1", "x": 29.31, "y": 65.37, "ingameCoords": "X:138 Y:666" },
      { "Type": "Construction", "Level": "Lv.1", "x": 14.19, "y": 50.73, "ingameCoords": "X:138 Y:1038" },
      { "Type": "Construction", "Level": "Lv.1", "x": 34.06, "y": 28.52, "ingameCoords": "X:666 Y:1068" },
      { "Type": "Construction", "Level": "Lv.1", "x": 70.19, "y": 32.57, "ingameCoords": "X:1068 Y:567" },
      { "Type": "Construction", "Level": "Lv.1", "x": 50.19, "y": 86.35, "ingameCoords": "X:138 Y:138" },
      { "Type": "Construction", "Level": "Lv.3", "x": 56.44, "y": 65.19, "ingameCoords": "X:486 Y:327" },
      { "Type": "Construction", "Level": "Lv.3", "x": 46.31, "y": 32.57, "ingameCoords": "X:768 Y:867" },
      { "Type": "Construction", "Level": "Lv.3", "x": 62.19, "y": 40.33, "ingameCoords": "X:867 Y:567" },
      { "Type": "Construction", "Level": "Lv.3", "x": 36.81, "y": 57.96, "ingameCoords": "X:327 Y:666" },
      { "Type": "Production", "Level": "Lv.1", "x": 83.31, "y": 45.45, "ingameCoords": "X:1068 Y:237" },
      { "Type": "Production", "Level": "Lv.1", "x": 75.19, "y": 61.49, "ingameCoords": "X:768 Y:138" },
      { "Type": "Production", "Level": "Lv.1", "x": 54.06, "y": 82.65, "ingameCoords": "X:237 Y:138" },
      { "Type": "Production", "Level": "Lv.1", "x": 42.56, "y": 78.94, "ingameCoords": "X:138 Y:327" },
      { "Type": "Production", "Level": "Lv.1", "x": 17.44, "y": 53.73, "ingameCoords": "X:138 Y:957" },
      { "Type": "Production", "Level": "Lv.1", "x": 21.81, "y": 42.98, "ingameCoords": "X:327 Y:1038" },
      { "Type": "Production", "Level": "Lv.1", "x": 63.19, "y": 25.17, "ingameCoords": "X:1068 Y:747" },
      { "Type": "Production", "Level": "Lv.1", "x": 45.69, "y": 17.06, "ingameCoords": "X:957 Y:1068" },
      { "Type": "Defense", "Level": "Lv.2", "x": 71.19, "y": 65.54, "ingameCoords": "X:666 Y:138" },
      { "Type": "Defense", "Level": "Lv.2", "x": 56.81, "y": 69.42, "ingameCoords": "X:438 Y:267" },
      { "Type": "Defense", "Level": "Lv.2", "x": 34.19, "y": 70.48, "ingameCoords": "X:138 Y:537" },
      { "Type": "Defense", "Level": "Lv.2", "x": 29.19, "y": 57.43, "ingameCoords": "X:237 Y:768" },
      { "Type": "Defense", "Level": "Lv.2", "x": 30.19, "y": 35.04, "ingameCoords": "X:537 Y:1038" },
      { "Type": "Defense", "Level": "Lv.2", "x": 41.44, "y": 30.11, "ingameCoords": "X:738 Y:957" },
      { "Type": "Defense", "Level": "Lv.2", "x": 66.19, "y": 28.34, "ingameCoords": "X:1068 Y:666" },
      { "Type": "Defense", "Level": "Lv.2", "x": 70.81, "y": 42.1, "ingameCoords": "X:957 Y:438" },
      { "Type": "Defense", "Level": "Lv.4", "x": 54.06, "y": 36.45, "ingameCoords": "X:816 Y:717" },
      { "Type": "Defense", "Level": "Lv.4", "x": 37.06, "y": 53.38, "ingameCoords": "X:387 Y:717" },
      { "Type": "Defense", "Level": "Lv.4", "x": 60.56, "y": 61.14, "ingameCoords": "X:588 Y:327" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 82.81, "y": 53.91, "ingameCoords": "X:957 Y:138" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 46.44, "y": 82.65, "ingameCoords": "X:138 Y:237" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 68.06, "y": 72.77, "ingameCoords": "X:537 Y:87" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 26.94, "y": 67.48, "ingameCoords": "X:87 Y:666" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 18.19, "y": 44.39, "ingameCoords": "X:267 Y:1068" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 30.06, "y": 26.93, "ingameCoords": "X:636 Y:1137" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 72.81, "y": 29.93, "ingameCoords": "X:1137 Y:567" },
      { "Type": "Gathering", "Level": "Lv.1", "x": 55.44, "y": 17.59, "ingameCoords": "X:1068 Y:936" },
      { "Type": "Tech", "Level": "Lv.1", "x": 78.94, "y": 50.03, "ingameCoords": "X:957 Y:237" },
      { "Type": "Tech", "Level": "Lv.1", "x": 66.06, "y": 60.25, "ingameCoords": "X:666 Y:267" },
      { "Type": "Tech", "Level": "Lv.1", "x": 50.31, "y": 78.77, "ingameCoords": "X:237 Y:237" },
      { "Type": "Tech", "Level": "Lv.1", "x": 39.44, "y": 65.37, "ingameCoords": "X:267 Y:537" },
      { "Type": "Tech", "Level": "Lv.1", "x": 21.44, "y": 49.85, "ingameCoords": "X:237 Y:957" },
      { "Type": "Tech", "Level": "Lv.1", "x": 34.31, "y": 38.75, "ingameCoords": "X:537 Y:936" },
      { "Type": "Tech", "Level": "Lv.1", "x": 66.06, "y": 39.1, "ingameCoords": "X:936 Y:537" },
      { "Type": "Tech", "Level": "Lv.1", "x": 50.19, "y": 21.29, "ingameCoords": "X:957 Y:957" },
      { "Type": "Tech", "Level": "Lv.3", "x": 71.75, "y": 50.03, "ingameCoords": "X:867 Y:327" },
      { "Type": "Tech", "Level": "Lv.3", "x": 50.25, "y": 71.36, "ingameCoords": "X:327 Y:327" },
      { "Type": "Tech", "Level": "Lv.3", "x": 28.63, "y": 49.85, "ingameCoords": "X:327 Y:867" },
      { "Type": "Tech", "Level": "Lv.3", "x": 50.13, "y": 28.52, "ingameCoords": "X:867 Y:867" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 79.13, "y": 57.43, "ingameCoords": "X:867 Y:138" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 59.13, "y": 77.18, "ingameCoords": "X:366 Y:138" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 38.25, "y": 74.54, "ingameCoords": "X:138 Y:438" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 21, "y": 57.61, "ingameCoords": "X:138 Y:867" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 25, "y": 37.69, "ingameCoords": "X:438 Y:1068" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 79.63, "y": 41.92, "ingameCoords": "X:1068 Y:327" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 58.13, "y": 20.76, "ingameCoords": "X:1068 Y:867" },
      { "Type": "Weapons", "Level": "Lv.2", "x": 42, "y": 20.41, "ingameCoords": "X:867 Y:1068" },
      { "Type": "Weapons", "Level": "Lv.4", "x": 63.5, "y": 45.27, "ingameCoords": "X:816 Y:486" },
      { "Type": "Weapons", "Level": "Lv.4", "x": 46.13, "y": 62.9, "ingameCoords": "X:387 Y:486" },
      { "Type": "Weapons", "Level": "Lv.4", "x": 38.88, "y": 39.8, "ingameCoords": "X:588 Y:867" },
      { "Type": "Training", "Level": "Lv.2", "x": 40.13, "y": 68.72, "ingameCoords": "X:237 Y:486" },
      { "Type": "Training", "Level": "Lv.2", "x": 25.62, "y": 62.19, "ingameCoords": "X:138 Y:747" },
      { "Type": "Training", "Level": "Lv.2", "x": 31.37, "y": 40.16, "ingameCoords": "X:486 Y:957" },
      { "Type": "Training", "Level": "Lv.2", "x": 39.25, "y": 25.52, "ingameCoords": "X:768 Y:1038" },
      { "Type": "Training", "Level": "Lv.2", "x": 58.25, "y": 29.93, "ingameCoords": "X:957 Y:747" },
      { "Type": "Training", "Level": "Lv.2", "x": 73.25, "y": 35.92, "ingameCoords": "X:1068 Y:486" },
      { "Type": "Training", "Level": "Lv.2", "x": 63.88, "y": 72.77, "ingameCoords": "X:486 Y:138" },
      { "Type": "Training", "Level": "Lv.2", "x": 71.13, "y": 57.43, "ingameCoords": "X:768 Y:237" },
      { "Type": "Expedition", "Level": "Lv.3", "x": 67.63, "y": 53.91, "ingameCoords": "X:768" },
      { "Type": "Expedition", "Level": "Lv.3", "x": 40.63, "y": 61.84, "ingameCoords": "X:327 Y:567" },
      { "Type": "Expedition", "Level": "Lv.3", "x": 34.88, "y": 43.68, "ingameCoords": "X:486 Y:867" },
      { "Type": "Expedition", "Level": "Lv.3", "x": 58.13, "y": 36.28, "ingameCoords": "X:867 Y:666" },
      { "Type": "Stronghold", "Level": "Lv.1", "x": 41.75, "y": 41.57 },
      { "Type": "Stronghold", "Level": "Lv.2", "x": 42.25, "y": 57.61 },
      { "Type": "Stronghold", "Level": "Lv.3", "x": 57.63, "y": 57.61 },
      { "Type": "Stronghold", "Level": "Lv.4", "x": 58, "y": 41.39 },
      { "Type": "Fortress", "Level": "Lv.1", "x": 26.63, "y": 54.97, "ingameCoords": "X:240 Y:831" },
      { "Type": "Fortress", "Level": "Lv.2", "x": 35.13, "y": 63.6, "ingameCoords": "X:240 Y:609" },
      { "Type": "Fortress", "Level": "Lv.3", "x": 45.63, "y": 74.01, "ingameCoords": "X:240 Y:351" },
      { "Type": "Fortress", "Level": "Lv.4", "x": 55.38, "y": 73.65, "ingameCoords": "X:369 Y:240" },
      { "Type": "Fortress", "Level": "Lv.5", "x": 64, "y": 64.31, "ingameCoords": "X:591 Y:240" },
      { "Type": "Fortress", "Level": "Lv.6", "x": 74.25, "y": 54.08, "ingameCoords": "X:849 Y:240" },
      { "Type": "Fortress", "Level": "Lv.7", "x": 74.25, "y": 45.45, "ingameCoords": "X:960 Y:351" },
      { "Type": "Fortress", "Level": "Lv.8", "x": 64.13, "y": 35.22, "ingameCoords": "X:960 Y:609" },
      { "Type": "Fortress", "Level": "Lv.9", "x": 55.25, "y": 26.23, "ingameCoords": "X:960 Y:831" },
      { "Type": "Fortress", "Level": "Lv.10", "x": 45.63, "y": 25.35, "ingameCoords": "X:849 Y:960" },
      { "Type": "Fortress", "Level": "Lv.11", "x": 35.88, "y": 34.87, "ingameCoords": "X:609 Y:960" },
      { "Type": "Fortress", "Level": "Lv.12", "x": 26.38, "y": 44.21, "ingameCoords": "X:369 Y:960" }
    ];

    const buffValues = {
      "Construction|Lv.1": "+5%",
      "Construction|Lv.3": "+10%",
      "Production|Lv.1": "+5%", 
      "Defense|Lv.2": "+8%",
      "Defense|Lv.4": "+10%",
      "Gathering|Lv.1": "+5%",
      "Tech|Lv.1": "+5%",
      "Tech|Lv.3": "+10%",
      "Weapons|Lv.2": "+8%",
      "Weapons|Lv.4": "+10%",
      "Training|Lv.2": "+8%",
      "Expedition|Lv.3": "+15%"
    };

    // === STATO ===
    const alliances = [];
    let calibrationSettings = { offsetX: 0, offsetY: 0.7, scaleX: 1.0, scaleY: 1.0 };
    let calibrationUnlocked = false;
    let currentLanguage = 'it';

    // === FUNZIONI UTILITIES ===
    function getRandomColor() {
      const colors = ['#d7263d', '#0074d9', '#2ecc71', '#ff851b', '#7fdbff', '#b10dc9'];
      return colors[Math.floor(Math.random() * colors.length)];
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('map-status');
      statusEl.textContent = message;
      statusEl.style.background = type === 'success' ? 'rgba(67, 233, 123, 0.2)' :
                                  type === 'error' ? 'rgba(220, 53, 69, 0.2)' :
                                  'rgba(79, 172, 254, 0.2)';
    }

    // === SISTEMA LINGUE ===
    function toggleLanguageSelector() {
      const selector = document.getElementById('language-selector');
      if (selector.classList.contains('hidden')) {
        selector.classList.remove('hidden');
        selector.style.animation = 'fadeIn 0.3s ease';
      } else {
        selector.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => selector.classList.add('hidden'), 300);
      }
    }

    function setLanguage(lang) {
      currentLanguage = lang;
      updateUILanguage();
      localStorage.setItem('whiteout-language', lang);
      showStatus(translations[lang].languageSet, 'success');
      
      document.getElementById('language-selector').classList.add('hidden');
      
      document.querySelectorAll('[id^="lang-"]').forEach(btn => {
        btn.classList.remove('btn-success');
        btn.classList.add('btn-info');
      });
      const currentBtn = document.getElementById(`lang-${lang}`);
      if (currentBtn) {
        currentBtn.classList.remove('btn-info');
        currentBtn.classList.add('btn-success');
      }
    }

    function updateUILanguage() {
      const t = translations[currentLanguage];
      
      // Titoli principali
      document.getElementById('main-title').textContent = t.title;
      document.getElementById('main-subtitle').textContent = t.subtitle;
      
      // Stats e form
      document.getElementById('alliances-label').textContent = t.alliances;
      document.getElementById('assigned-label').textContent = t.assigned;
      document.getElementById('alliance-management-title').textContent = t.allianceManagement;
      document.getElementById('alliance-name').placeholder = t.allianceName;
      document.getElementById('add-alliance-btn').innerHTML = t.addAlliance;
      
      // Pulsanti controlli
      document.getElementById('export-csv-btn').innerHTML = t.exportCSV;
      document.getElementById('export-png-btn').innerHTML = t.exportPNG;
      document.getElementById('import-csv-btn').innerHTML = t.importCSV;
      document.getElementById('language-btn').innerHTML = t.language;
      
      // Selettore lingua
      document.getElementById('select-language-title').textContent = t.selectLanguage;
      
      // Mappa
      document.getElementById('map-title').textContent = t.interactiveMap;
      document.getElementById('legend-btn').innerHTML = `üé® ${t.legend}`;
      document.getElementById('legend-title').textContent = t.legendTitle;
      
      // Colori legenda
      document.getElementById('color-castle').textContent = t.colorCastle;
      document.getElementById('color-construction').textContent = t.colorConstruction;
      document.getElementById('color-production').textContent = t.colorProduction;
      document.getElementById('color-defense').textContent = t.colorDefense;
      document.getElementById('color-gathering').textContent = t.colorGathering;
      document.getElementById('color-tech').textContent = t.colorTech;
      document.getElementById('color-weapons').textContent = t.colorWeapons;
      document.getElementById('color-training').textContent = t.colorTraining;
      document.getElementById('color-expedition').textContent = t.colorExpedition;
      document.getElementById('color-stronghold').textContent = t.colorStronghold;
      document.getElementById('color-fortress').textContent = t.colorFortress;
      
      // Riepiloghi
      document.getElementById('facility-summary-title').textContent = t.facilitySummary;
      document.getElementById('buff-summary-title').textContent = t.buffSummary;
      document.getElementById('calibration-title').textContent = t.advancedCalibration;
      
      // Aggiorna i riepiloghi
      updateSummaries();
    }

    // === CALIBRAZIONE ===
    function checkCalibrationPassword() {
      const password = document.getElementById('calibration-password').value;
      if (password === 'calibration') {
        calibrationUnlocked = true;
        document.getElementById('password-section').classList.add('hidden');
        document.getElementById('calibration-controls-section').classList.remove('hidden');
        showStatus(translations[currentLanguage].calibrationUnlocked, 'success');
      } else {
        showStatus(translations[currentLanguage].wrongPassword, 'error');
        document.getElementById('calibration-password').value = '';
      }
    }

    function updateCalibrationFromInputs() {
      if (!calibrationUnlocked) return;
      calibrationSettings.offsetX = parseFloat(document.getElementById('offsetX').value) || 0;
      calibrationSettings.offsetY = parseFloat(document.getElementById('offsetY').value) || 0;
      calibrationSettings.scaleX = parseFloat(document.getElementById('scaleX').value) || 1;
      calibrationSettings.scaleY = parseFloat(document.getElementById('scaleY').value) || 1;
    }

    function applyMarkerPosition(facility) {
      const adjustedX = (facility.x * calibrationSettings.scaleX) + calibrationSettings.offsetX;
      const adjustedY = (facility.y * calibrationSettings.scaleY) + calibrationSettings.offsetY;
      return { x: adjustedX, y: adjustedY };
    }

    function highlightCastle() {
      if (!calibrationUnlocked) return;
      const castle = facilityData.find(f => f.Type === "Castle");
      if (castle && castle.marker) {
        castle.marker.style.backgroundColor = 'red';
        castle.marker.style.width = '20px';
        castle.marker.style.height = '20px';
        castle.marker.style.zIndex = '1000';
        castle.marker.style.border = '3px solid yellow';
        showStatus('üè∞ Castello evidenziato in rosso.', 'info');
        
        setTimeout(() => {
          if (castle.marker) {
            castle.marker.style.backgroundColor = '';
            castle.marker.style.width = '';
            castle.marker.style.height = '';
            castle.marker.style.zIndex = '';
            castle.marker.style.border = '';
          }
        }, 5000);
      }
    }

    function testCurrentCalibration() {
      if (!calibrationUnlocked) return;
      updateCalibrationFromInputs();
      recreateAllMarkers();
      showStatus('üéØ Calibrazione testata.', 'info');
    }

    function applyCalibration() {
      if (!calibrationUnlocked) return;
      updateCalibrationFromInputs();
      recreateAllMarkers();
      localStorage.setItem('whiteout-calibration', JSON.stringify(calibrationSettings));
      showStatus('‚úÖ Calibrazione applicata!', 'success');
    }

    function resetCalibration() {
      if (!calibrationUnlocked) return;
      calibrationSettings = { offsetX: 0, offsetY: 0.7, scaleX: 1.0, scaleY: 1.0 };
      
      document.getElementById('offsetX').value = calibrationSettings.offsetX;
      document.getElementById('offsetY').value = calibrationSettings.offsetY;
      document.getElementById('scaleX').value = calibrationSettings.scaleX;
      document.getElementById('scaleY').value = calibrationSettings.scaleY;
      
      recreateAllMarkers();
      showStatus('üîÑ Calibrazione resettata', 'info');
    }

    function debugMarkers() {
      if (!calibrationUnlocked) return;
      console.log('=== DEBUG MARKERS ===');
      console.log('Total facilities:', facilityData.length);
      console.log('Calibration settings:', calibrationSettings);
      
      const markersOnPage = document.querySelectorAll('.marker').length;
      console.log('Markers on page:', markersOnPage);
      
      showStatus(`üîç Debug: ${markersOnPage} marker su ${facilityData.length} strutture.`, 'info');
    }

    function toggleCalibration() {
      const content = document.getElementById('calibration-content');
      const toggle = document.querySelector('.calibration-toggle');
      
      if (content.classList.contains('collapsed-content')) {
        content.classList.remove('collapsed-content');
        content.classList.add('expanded-content');
        toggle.textContent = '‚ñº';
      } else {
        content.classList.remove('expanded-content');
        content.classList.add('collapsed-content');
        toggle.textContent = '‚ñ∂';
        if (!calibrationUnlocked) {
          document.getElementById('password-section').classList.remove('hidden');
          document.getElementById('calibration-controls-section').classList.add('hidden');
          document.getElementById('calibration-password').value = '';
        }
      }
    }

    function toggleLegend() {
      const legend = document.getElementById('map-legend');
      if (legend.classList.contains('hidden')) {
        legend.classList.remove('hidden');
        legend.style.animation = 'fadeIn 0.3s ease';
      } else {
        legend.style.animation = 'fadeOut 0.3s ease';
        setTimeout(() => legend.classList.add('hidden'), 300);
      }
    }

    // === MARKER ===
    function createMarker(facility, index) {
      const mapWrapper = document.getElementById('map-wrapper');
      if (!mapWrapper) return;

      if (facility.marker) {
        facility.marker.remove();
      }

      const marker = document.createElement('div');
      marker.className = `marker ${facility.Type.toLowerCase()}`;
      
      const pos = applyMarkerPosition(facility);
      marker.style.left = `calc(${pos.x}% - 6px)`;
      marker.style.top = `calc(${pos.y}% - 6px)`;
      
      marker.title = `${facility.Type} ${facility.Level}${facility.ingameCoords ? ' (' + facility.ingameCoords + ')' : ''}`;
      marker.onclick = () => showDropdown(facility, marker, index);
      
      mapWrapper.appendChild(marker);
      facility.marker = marker;

      if (facility.Alliance) {
        renderAllianceIcon(facility);
        marker.classList.add('assigned');
      }
      
      return marker;
    }

    function recreateAllMarkers() {
      document.querySelectorAll('.marker').forEach(marker => marker.remove());
      
      facilityData.forEach(facility => {
        facility.marker = null;
      });
      
      let createdCount = 0;
      facilityData.forEach((facility, index) => {
        const marker = createMarker(facility, index);
        if (marker) createdCount++;
      });
      
      showStatus(`üìç ${createdCount} marker aggiornati`, 'info');
    }

    function showDropdown(facility, marker, index) {
      const t = translations[currentLanguage];
      if (alliances.length === 0) {
        showStatus(t.addAtLeastOneAlliance, 'error');
        return;
      }

      closeAllDropdowns();

      const dropdown = document.createElement('div');
      dropdown.className = 'marker-dropdown';
      
      const mapWrapper = document.getElementById('map-wrapper');
      const markerRect = marker.getBoundingClientRect();
      const mapRect = mapWrapper.getBoundingClientRect();
      
      const markerTopRelative = markerRect.top - mapRect.top;
      const mapHeight = mapRect.height;
      
      if (markerTopRelative > mapHeight * 0.5) {
        dropdown.classList.add('dropdown-above');
      }
      
      // Header con coordinate
      const header = document.createElement('div');
      header.className = 'dropdown-header';
      const coordsText = facility.ingameCoords ? ` - ${facility.ingameCoords}` : '';
      header.textContent = `${facility.Type} ${facility.Level}${coordsText}`;
      dropdown.appendChild(header);
      
      // Opzione per rimuovere assegnazione
      const unassignOption = document.createElement('div');
      unassignOption.className = 'dropdown-option unassign';
      unassignOption.innerHTML = t.unassigned;
      if (!facility.Alliance) {
        unassignOption.classList.add('selected');
      }
      unassignOption.onclick = (e) => {
        e.stopPropagation();
        assignFacilityToAlliance(facility, marker, null);
        dropdown.remove();
      };
      dropdown.appendChild(unassignOption);
      
      // Opzioni per le alleanze
      alliances.forEach(alliance => {
        const option = document.createElement('div');
        option.className = 'dropdown-option';
        if (facility.Alliance === alliance.name) {
          option.classList.add('selected');
        }
        
        option.innerHTML = `
          <img src="${alliance.icon}" alt="${alliance.name}" class="alliance-icon-small">
          <span>${alliance.name}</span>
        `;
        
        option.onclick = (e) => {
          e.stopPropagation();
          assignFacilityToAlliance(facility, marker, alliance.name);
          dropdown.remove();
        };
        
        dropdown.appendChild(option);
      });
      
      marker.appendChild(dropdown);
      
      setTimeout(() => {
        if (dropdown.parentNode) {
          dropdown.remove();
        }
      }, 8000);
      
      setTimeout(() => {
        document.addEventListener('click', handleOutsideClick, { once: true });
      }, 100);
      
      function handleOutsideClick(e) {
        if (!dropdown.contains(e.target) && dropdown.parentNode) {
          dropdown.remove();
        }
      }
    }

    function assignFacilityToAlliance(facility, marker, allianceName) {
      facility.Alliance = allianceName;
      
      renderAllianceIcon(facility);
      
      if (allianceName) {
        marker.classList.add('assigned');
        showStatus(`‚úÖ ${facility.Type} assegnata a ${allianceName}`, 'success');
      } else {
        marker.classList.remove('assigned');
        showStatus(`‚ùå ${facility.Type} rimossa`, 'info');
      }
      
      updateStats();
      updateSummaries();
      saveData();
    }

    function closeAllDropdowns() {
      document.querySelectorAll('.marker-dropdown').forEach(dropdown => {
        dropdown.style.animation = 'fadeOut 0.2s ease';
        setTimeout(() => {
          if (dropdown.parentNode) {
            dropdown.remove();
          }
        }, 200);
      });
    }

    function renderAllianceIcon(facility) {
      if (!facility.marker) return;
      
      facility.marker.querySelectorAll('img').forEach(e => e.remove());
      
      const alliance = alliances.find(a => a.name === facility.Alliance);
      if (alliance) {
        const icon = document.createElement('img');
        icon.src = alliance.icon;
        icon.alt = `${facility.Alliance} icon`;
        facility.marker.appendChild(icon);
      }
    }

    // === GESTIONE ALLEANZE ===
    function renderAllianceList() {
      const list = document.getElementById('alliance-list');
      list.innerHTML = '';
      
      alliances.forEach((alliance, index) => {
        const li = document.createElement('li');
        li.className = 'alliance-item';
        
        const assignedCount = facilityData.filter(f => f.Alliance === alliance.name).length;
        const t = translations[currentLanguage];
        
        li.innerHTML = `
          <img src="${alliance.icon}" alt="${alliance.name}">
          <span class="alliance-name">${alliance.name}</span>
          <span style="font-size: 11px; color: var(--text-secondary);">${assignedCount} ${t.assigned}</span>
          <div class="alliance-actions">
            <button class="action-btn edit-btn" onclick="editAlliance(${index})">‚úèÔ∏è</button>
            <button class="action-btn delete-btn" onclick="deleteAlliance(${index})">üóëÔ∏è</button>
          </div>
        `;
        
        list.appendChild(li);
      });
    }

    function editAlliance(index) {
      const alliance = alliances[index];
      const newName = prompt('Nuovo nome alleanza:', alliance.name);
      if (newName && newName.trim()) {
        const oldName = alliance.name;
        alliance.name = newName.trim();
        
        facilityData.forEach(f => {
          if (f.Alliance === oldName) {
            f.Alliance = newName.trim();
          }
        });
        
        renderAllianceList();
        updateSummaries();
        saveData();
      }
    }

    function deleteAlliance(index) {
      const alliance = alliances[index];
      const assignedCount = facilityData.filter(f => f.Alliance === alliance.name).length;
      const t = translations[currentLanguage];
      
      let confirmMsg = `Eliminare "${alliance.name}"?`;
      if (assignedCount > 0) {
        confirmMsg += `\nAttenzione: ${assignedCount} strutture assegnate verranno liberate.`;
      }
      
      if (confirm(confirmMsg)) {
        facilityData.forEach(f => {
          if (f.Alliance === alliance.name) {
            delete f.Alliance;
            if (f.marker) {
              renderAllianceIcon(f);
              f.marker.classList.remove('assigned');
            }
          }
        });
        
        alliances.splice(index, 1);
        renderAllianceList();
        updateStats();
        updateSummaries();
        saveData();
      }
    }

    // === AGGIORNAMENTI UI ===
    function updateStats() {
      document.getElementById('total-alliances').textContent = alliances.length;
      document.getElementById('assigned-facilities').textContent = 
        facilityData.filter(f => f.Alliance).length;
    }

    function updateSummaries() {
      renderFacilitySummary();
      renderBuffSummary();
    }

    function renderFacilitySummary() {
      const container = document.getElementById('facility-summary');
      const t = translations[currentLanguage];
      
      const grouped = {};
      facilityData.forEach(f => {
        if (!grouped[f.Type]) grouped[f.Type] = [];
        grouped[f.Type].push(f);
      });
      
      let html = '';
      Object.entries(grouped).forEach(([type, facilities]) => {
        const assigned = facilities.filter(f => f.Alliance).length;
        html += `
          <div style="margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <strong>${type}</strong> (${assigned}/${facilities.length} ${t.assigned})
            <div style="margin-top: 5px; font-size: 12px;">
              ${facilities.map(f => 
                `<span style="margin-right: 10px; ${f.Alliance ? 'color: #43e97b' : 'color: var(--text-secondary)'}">
                  ${f.Level}${f.Alliance ? ' ‚Üí ' + f.Alliance : ''}
                </span>`
              ).join('')}
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html || `<p>${t.noStructuresLoaded}</p>`;
    }

    function renderBuffSummary() {
      const container = document.getElementById('buff-summary');
      const t = translations[currentLanguage];
      const byAlliance = {};

      facilityData.forEach(f => {
        if (!f.Alliance) return;
        if (!byAlliance[f.Alliance]) byAlliance[f.Alliance] = [];
        byAlliance[f.Alliance].push(f);
      });

      let html = '';
      Object.entries(byAlliance).forEach(([alliance, facilities]) => {
        const unique = new Set(facilities.map(f => `${f.Type}|${f.Level}`));
        const buffs = [...unique]
          .map(key => buffValues[key] ? `${buffValues[key]} ${key.split('|')[0]}` : null)
          .filter(Boolean)
          .join(', ');

        html += `
          <div style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.05); border-radius: 8px;">
            <strong style="color: #43e97b;">${alliance}</strong><br>
            <span style="font-size: 14px; color: var(--text-secondary);">${buffs || t.noBuffRecognized}</span>
            <div style="margin-top: 8px; font-size: 12px;">
              ${facilities.length} ${t.structures}: ${[...unique].join(', ')}
            </div>
          </div>
        `;
      });

      container.innerHTML = html || `<p>${t.noAllianceAssigned}</p>`;
    }

    function toggleSection(sectionId) {
      const content = document.getElementById(`${sectionId}-content`);
      const toggle = document.getElementById(`${sectionId.replace('-summary', '')}-toggle`);
      
      if (content.classList.contains('collapsed-content')) {
        content.classList.remove('collapsed-content');
        content.classList.add('expanded-content');
        toggle.textContent = '‚ñº';
        toggle.classList.remove('collapsed');
      } else {
        content.classList.remove('expanded-content');
        content.classList.add('collapsed-content');
        toggle.textContent = '‚ñ∂';
        toggle.classList.add('collapsed');
      }
    }

    // === PERSISTENZA DATI ===
    function saveData() {
      const data = {
        alliances: alliances,
        facilityAssignments: facilityData.map(f => ({
          Type: f.Type,
          Level: f.Level,
          x: f.x,
          y: f.y,
          Alliance: f.Alliance
        })),
        calibration: calibrationSettings
      };
      localStorage.setItem('whiteout-companion-data', JSON.stringify(data));
    }

    function loadData() {
      const saved = localStorage.getItem('whiteout-companion-data');
      if (saved) {
        try {
          const data = JSON.parse(saved);
          
          if (data.alliances) {
            alliances.splice(0, alliances.length, ...data.alliances);
          }
          
          if (data.facilityAssignments) {
            data.facilityAssignments.forEach(saved => {
              const facility = facilityData.find(f => 
                f.Type === saved.Type && 
                f.Level === saved.Level && 
                Math.abs(f.x - saved.x) < 0.1 && 
                Math.abs(f.y - saved.y) < 0.1
              );
              if (facility && saved.Alliance) {
                facility.Alliance = saved.Alliance;
              }
            });
          }
          
          if (data.calibration) {
            calibrationSettings = data.calibration;
            if (calibrationUnlocked) {
              document.getElementById('offsetX').value = calibrationSettings.offsetX;
              document.getElementById('offsetY').value = calibrationSettings.offsetY;
              document.getElementById('scaleX').value = calibrationSettings.scaleX;
              document.getElementById('scaleY').value = calibrationSettings.scaleY;
            }
          }
        } catch (error) {
          console.error('Error loading data:', error);
        }
      }
      
      const savedLanguage = localStorage.getItem('whiteout-language');
      if (savedLanguage && translations[savedLanguage]) {
        currentLanguage = savedLanguage;
      }
    }

    // === FUNZIONI EXPORT ===
    function exportCSV() {
      const csvContent = "Type,Level,X,Y,Alliance\n" + 
        facilityData.map(f => `${f.Type},${f.Level},${f.x},${f.y},${f.Alliance || ""}`).join("\n");
      
      const blob = new Blob([csvContent], { type: "text/csv" });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "whiteout_facilities.csv";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      window.URL.revokeObjectURL(url);
    }

    function exportPNG() {
      showStatus('üñºÔ∏è Funzione esportazione PNG in sviluppo', 'info');
    }

    // === EVENT LISTENERS ===
    document.getElementById('alliance-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const t = translations[currentLanguage];
      
      const nameInput = document.getElementById('alliance-name');
      const name = nameInput.value.trim();
      const file = document.getElementById('alliance-icon').files[0];
      
      if (!name) {
        alert(t.enterAllianceName);
        return;
      }
      
      if (alliances.find(a => a.name.toLowerCase() === name.toLowerCase())) {
        alert(t.allianceExists);
        return;
      }
      
      if (alliances.length >= 50) {
        alert(t.maxAlliances);
        return;
      }
      
      const processIcon = (iconData) => {
        alliances.push({ name, icon: iconData });
        renderAllianceList();
        updateStats();
        saveData();
        nameInput.value = '';
        document.getElementById('alliance-icon').value = '';
        showStatus(`‚úÖ Alleanza "${name}" creata!`, 'success');
      };
      
      if (file) {
        const reader = new FileReader();
        reader.onload = (evt) => processIcon(evt.target.result);
        reader.readAsDataURL(file);
      } else {
        const defaultIcon = "data:image/svg+xml;base64," + btoa(`
          <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'>
            <circle cx='12' cy='12' r='12' fill='${getRandomColor()}'/>
            <text x='12' y='16' text-anchor='middle' fill='white' font-family='Arial' font-size='14' font-weight='bold'>
              ${name.charAt(0).toUpperCase()}
            </text>
          </svg>
        `);
        processIcon(defaultIcon);
      }
    });

    // Import CSV
    document.getElementById('import-file').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const t = translations[currentLanguage];
      
      const reader = new FileReader();
      reader.onload = (evt) => {
        try {
          const csv = evt.target.result;
          const lines = csv.split('\n').filter(line => line.trim());
          
          if (lines.length < 2) {
            alert(t.emptyCsv);
            return;
          }
          
          facilityData.forEach(f => delete f.Alliance);
          
          let importedCount = 0;
          const newAlliances = new Set();
          
          for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            
            if (values.length >= 5) {
              const [type, level, x, y, alliance] = values;
              
              if (alliance.trim()) {
                newAlliances.add(alliance.trim());
              }
              
              const facility = facilityData.find(f => 
                f.Type === type && 
                f.Level === level && 
                Math.abs(f.x - parseFloat(x)) < 0.1 && 
                Math.abs(f.y - parseFloat(y)) < 0.1
              );
              
              if (facility && alliance.trim()) {
                facility.Alliance = alliance.trim();
                importedCount++;
              }
            }
          }
          
          newAlliances.forEach(allianceName => {
            if (!alliances.find(a => a.name.toLowerCase() === allianceName.toLowerCase())) {
              const defaultIcon = "data:image/svg+xml;base64," + btoa(`
                <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24'>
                  <circle cx='12' cy='12' r='12' fill='${getRandomColor()}'/>
                  <text x='12' y='16' text-anchor='middle' fill='white' font-family='Arial' font-size='14' font-weight='bold'>
                    ${allianceName.charAt(0).toUpperCase()}
                  </text>
                </svg>
              `);
              alliances.push({ name: allianceName, icon: defaultIcon });
            }
          });
          
          facilityData.forEach(f => {
            if (f.marker) {
              renderAllianceIcon(f);
              if (f.Alliance) {
                f.marker.classList.add('assigned');
              } else {
                f.marker.classList.remove('assigned');
              }
            }
          });
          
          renderAllianceList();
          updateStats();
          updateSummaries();
          saveData();
          
          showStatus(`‚úÖ Importate ${importedCount} assegnazioni!`, 'success');
          
        } catch (error) {
          console.error("Import error:", error);
          alert(t.importError);
        }
      };
      
      reader.readAsText(file);
      e.target.value = '';
    });

    // Auto-apply calibration
    ['offsetX', 'offsetY', 'scaleX', 'scaleY'].forEach(id => {
      const input = document.getElementById(id);
      input.addEventListener('blur', () => {
        if (calibrationUnlocked) {
          updateCalibrationFromInputs();
          recreateAllMarkers();
        }
      });
      
      input.addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && calibrationUnlocked) {
          updateCalibrationFromInputs();
          recreateAllMarkers();
        }
      });
    });

    // Password input enter key
    document.getElementById('calibration-password').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        checkCalibrationPassword();
      }
    });

    // Close dropdowns when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.marker') && !e.target.closest('.marker-dropdown')) {
        setTimeout(() => {
          closeAllDropdowns();
        }, 50);
      }
    });

    // === INIZIALIZZAZIONE ===
    document.addEventListener('DOMContentLoaded', () => {
      console.log('=== WHITEOUT COMPANION INIT ===');
      
      loadData();
      
      const mapImg = document.getElementById('map');
      if (mapImg.complete) {
        initializeMarkers();
      } else {
        mapImg.onload = initializeMarkers;
        mapImg.onerror = () => {
          console.warn('Map image failed to load, proceeding anyway...');
          initializeMarkers();
        };
      }
      
      function initializeMarkers() {
        console.log('Initializing markers...');
        
        let createdCount = 0;
        facilityData.forEach((facility, index) => {
          try {
            const marker = createMarker(facility, index);
            if (marker) createdCount++;
          } catch (error) {
            console.error(`Error creating marker for facility ${index}:`, error, facility);
          }
        });
        
        console.log(`Created ${createdCount} markers out of ${facilityData.length} facilities`);
        
        renderAllianceList();
        updateStats();
        updateSummaries();
        
        // Setup language
        updateUILanguage();
        setLanguage(currentLanguage);
        
        const t = translations[currentLanguage];
        showStatus(t.appLoaded.replace('{count}', createdCount), 'success');
        
        console.log('Calibrazione caricata:', calibrationSettings);
        console.log('Alleanze caricate:', alliances.length);
        console.log('Strutture totali:', facilityData.length);
        console.log('Marker creati:', createdCount);
      }
    });
  </script>
</body>
</html>
